<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã‚¹ã‚¯ãƒ¼ãƒ«ãƒã‚¹ä¹—è»Šç¢ºèª</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap');
    body { font-family: 'Inter','Noto Sans JP',system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; -webkit-tap-highlight-color: transparent; }

    ::-webkit-scrollbar{ width:8px; height:8px; }
    ::-webkit-scrollbar-track{ background:#eef2ff; }
    ::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:10px; }
    ::-webkit-scrollbar-thumb:hover{ background:#94a3b8; }

    /* â˜…A4ç¸¦å‘ãã«å›ºå®šï¼ˆ@media ã®å¤–ã«å‡ºã™æ–¹ãŒå®‰å®šï¼‰ */
    @page{ size:A4 portrait; margin:7mm; }

    @media print{
  .no-print{ display:none !important; }

  /* =========================
     â˜…Edgeç™½ç´™ãƒšãƒ¼ã‚¸å¯¾ç­–ï¼ˆè¿½åŠ ï¼‰
     1) body ã® min-h-screen(=min-height:100vh) ã‚’å°åˆ·ã§ã¯ç„¡åŠ¹åŒ–
     2) section-print ã® space-y-* ãŒ display:none ã§ã‚‚ä½™ç™½ã‚’ä½œã‚‹ã®ã‚’ç„¡åŠ¹åŒ–
     3) fixedç³»ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤/ãƒˆãƒ¼ã‚¹ãƒˆ/ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ã‚’å®Œå…¨æ’é™¤
  ========================= */
  html, body{
    height:auto !important;
    min-height:auto !important;
  }

  #section-print{
    padding:0 !important;
    margin:0 !important;
  }
  /* Tailwindã®space-y-*å¯¾ç­–ï¼ˆdisplay:noneã§ã‚‚marginãŒæ®‹ã‚‹ã“ã¨ãŒã‚ã‚‹ï¼‰ */
  #section-print > :not([hidden]) ~ :not([hidden]){
    margin-top:0 !important;
  }

  #login-overlay, #cloud-error-overlay, #modal,
  #toast, #toast *{
    display:none !important;
  }

  /* å°åˆ·æ™‚ã¯å°åˆ·ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã ã‘è¡¨ç¤º */
  header,
  #section-overview,
  #section-check,
  #section-monitor,
  #section-settings{
    display:none !important;
  }

  /* hidden ãŒä»˜ã„ã¦ã„ã¦ã‚‚å°åˆ·ã ã‘ã¯å‡ºã™ï¼ˆå°åˆ·ã‚¿ãƒ–ã®ä¸­èº«ï¼‰ */
  #section-print{
    display:block !important;
  }

  body{
    background:white !important;
    margin:0 !important;
    padding:0 !important;

    /* â˜…Edgeç™½ç´™å¯¾ç­–ï¼š100vhç³»ãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç³»ã‚’å°åˆ·ã§ã¯è§£é™¤ */
    height:auto !important;
    min-height:auto !important;
    overflow:visible !important;

    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  .print-shell{
    max-width:100% !important;
    width:100% !important;
    padding:0 !important;
    margin:0 !important;
  }

  /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ ã®ä½™ç™½/è£…é£¾ã‚’è½ã¨ã—ã¦å°åˆ·ã‚’ç¶ºéº—ã« */
  #print-content{
    padding:0 !important;
    margin:0 !important;
    border:none !important;
    box-shadow:none !important;
    background:transparent !important;
    overflow:visible !important;
  }

  /* =========================
     â˜…ç™½ç´™ãƒšãƒ¼ã‚¸å¯¾ç­–ï¼ˆã“ã“ãŒè‚ï¼‰
     - æœ«å°¾ã®æ”¹ãƒšãƒ¼ã‚¸(after)ã‚’ã‚„ã‚ã‚‹
     - 2æšç›®ä»¥é™ã®ã€Œå‰ã€ã§æ”¹ãƒšãƒ¼ã‚¸
  ========================= */
  #print-content .print-page{
    display:block;
    width:100%;
    margin:0 !important;

    /* æœ«å°¾æ”¹ãƒšãƒ¼ã‚¸ã‚’ç¦æ­¢ï¼ˆç™½ç´™ãƒšãƒ¼ã‚¸æ ¹çµ¶ï¼‰ */
    page-break-after:auto !important;
    break-after:auto !important;

    /* é€”ä¸­åˆ†å‰²ã‚‚æŠ‘æ­¢ */
    page-break-inside:avoid !important;
    break-inside:avoid !important;
  }

  /* 2ãƒšãƒ¼ã‚¸ç›®ä»¥é™ã®å‰ã§æ”¹ãƒšãƒ¼ã‚¸ */
  #print-content .print-page + .print-page{
    page-break-before:always !important;
    break-before:page !important;
  }

  /* â˜…å¿µæŠ¼ã—ï¼šæœ€å¾Œã®ãƒšãƒ¼ã‚¸ã®æœ«å°¾ã§â€œå¼·åˆ¶çš„ã«æ¬¡ãƒšãƒ¼ã‚¸â€ã‚’ä½œã‚‰ã›ãªã„ */
  #print-content > .print-page:last-child{
    page-break-after:auto !important;
    break-after:auto !important;
  }

  /* ä»¥é™ã¯æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆãã®ã¾ã¾ï¼‰ */
  .print-card{ border:2px solid #000 !important; box-shadow:none !important; }

  .print-title{
    border-bottom:3px solid #000 !important;
    padding-bottom:2.2mm !important;
    margin-bottom:2.2mm !important;
  }
  .print-title .print-title-en{ font-size:13pt !important; font-weight:900 !important; line-height:1.1 !important; }
  .print-title .print-title-ja{ font-size:10.5pt !important; font-weight:900 !important; line-height:1.15 !important; }

  table{ width:100% !important; border-collapse:collapse !important; table-layout:fixed !important; }
  th,td{ border:1px solid #000 !important; vertical-align:middle; }

  .td-name{ font-weight:900 !important; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .td-stop{ white-space:normal; overflow-wrap:anywhere; word-break:break-word; }
  .td-class{ font-weight:900 !important; white-space:nowrap !important; overflow:hidden !important; text-overflow:ellipsis !important; text-align:center !important; }

  .print-bus-card{
    border:2px solid #000 !important;
    padding:2.0mm !important;
    page-break-inside:avoid;
    break-inside:avoid;
  }
  .print-bus-title{
    font-size:10.5pt !important;
    font-weight:900 !important;
    margin:0 0 1.6mm 0 !important;
    line-height:1.1 !important;
  }

  .print-bus-card .td-name,
  .print-bus-card .td-class{
    white-space:nowrap !important;
    overflow:hidden !important;
    text-overflow:ellipsis !important;
  }

  .print-bus-card table th{
    background:#f3f4f6 !important;
    font-size:7.0pt !important;
    padding:1.0mm 1.0mm !important;
    line-height:1.02 !important;
  }
  .print-bus-card table td{
    font-size:7.4pt !important;
    padding:1.0mm 1.0mm !important;
    line-height:1.02 !important;
  }
  .print-bus-card table tbody tr{ height:4.05mm; }

  .print-page.bus-sheet{ padding:2.0mm !important; }
  .bus-sheet .print-title{
    padding-bottom:1.6mm !important;
    margin-bottom:1.6mm !important;
    border-bottom:3px solid #000 !important;
  }
  .bus-sheet .print-title .print-title-en{ font-size:11pt !important; }
  .bus-sheet .print-title .print-title-ja{ font-size:9.2pt !important; }

  /* â˜…å·®ã—æ›¿ãˆï¼šå°åˆ·æ™‚ã¯ grid ã‚’ã‚„ã‚ã‚‹ï¼ˆChrome/Edgeã®â€œæœ€å¾Œã«ç™½ç´™ãƒšãƒ¼ã‚¸â€å¯¾ç­–ï¼‰ */
  .print-bus-sheet{ display:block !important; }
  .print-bus-sheet .print-bus-card{ margin:0 0 2.2mm 0 !important; }
  .print-bus-sheet .print-bus-card:last-child{ margin-bottom:0 !important; }

  /* â†“ã“ã“ã‹ã‚‰ä¸‹ã¯â€œã‚ãªãŸã®æ—¢å­˜â€ã‚’ãã®ã¾ã¾ç¶­æŒï¼ˆä¸Šã®gridæŒ‡å®šã ã‘é™¤å»ï¼‰ */
  .print-bus-sheet .print-bus-card{ padding:1.6mm !important; }
  .print-bus-sheet .print-bus-title{ font-size:9.2pt !important; margin:0 0 1.2mm 0 !important; }
  .print-bus-sheet .print-bus-card table th{ font-size:6.0pt !important; padding:0.8mm 0.8mm !important; line-height:1.02 !important; }
  .print-bus-sheet .print-bus-card table td{ font-size:6.4pt !important; padding:0.8mm 0.8mm !important; line-height:1.02 !important; }
  .print-bus-sheet .print-bus-card table tbody tr{ height:3.45mm; }

  .print-class-card{
    border:2px solid #000 !important;
    padding:3mm !important;
    margin-bottom:5mm !important;
    page-break-inside:avoid;
    break-inside:avoid;
  }
  .print-class-title{
    font-size:12pt !important;
    font-weight:900 !important;
    margin-bottom:2mm !important;
  }

  .compact td{ font-size:9pt !important; padding:5px 6px !important; }
  .compact th{ font-size:8.5pt !important; padding:5px 6px !important; }
}



    .tap{ transition:transform .08s ease, box-shadow .08s ease; }
    .tap:active{ transform:scale(.98); }

    .tab-active{
      background:#eff6ff;
      border-bottom:3px solid #2563eb;
      color:#1e3a8a;
      font-weight:900;
    }

    .chip{ display:inline-flex; align-items:center; gap:.35rem; padding:.18rem .5rem; border-radius:.65rem; font-weight:900; font-size:11px; border:1px solid transparent; white-space:nowrap; line-height:1; }
    .chip-none{ background:#f8fafc; color:#64748b; border-color:#e2e8f0; }
    .chip-ride{ background:#dbeafe; color:#1e40af; border-color:#bfdbfe; }
    .chip-absent{ background:#f1f5f9; color:#475569; border-color:#e2e8f0; }
    .chip-pickup{ background:#dcfce7; color:#14532d; border-color:#bbf7d0; }
    .chip-other{ background:#fef3c7; color:#78350f; border-color:#fde68a; }

    .bus-u{ background-color:#dbeafe; color:#1e40af; border:1px solid #bfdbfe; }
    .bus-s{ background-color:#fef3c7; color:#92400e; border:1px solid #fde68a; }
    .bus-t{ background-color:#ffe4e6; color:#9f1239; border:1px solid #fecdd3; }

    .toast-in{ animation:toastIn .18s ease-out; }
    @keyframes toastIn{ from{ transform:translateY(8px); opacity:0; } to{ transform:translateY(0); opacity:1; } }

    .modal-backdrop{ background:rgba(15,23,42,.55); }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ”ãƒ«ãŒç¸®ã‚“ã§ç¸¦æ›¸ãã«ãªã‚‹ã®ã‚’é˜²æ­¢ï¼ˆJSã§classãŒä¸Šæ›¸ãã•ã‚Œã¦ã‚‚åŠ¹ãï¼‰ */
    #cloud-pill, #auth-pill { white-space: nowrap; flex-shrink: 0; }
  </style>

  <!-- Firebaseï¼ˆã“ã®JSã¯ window.firebase ã‚’ä½¿ã†ã®ã§å¿…é ˆï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
</head>

<body class="bg-slate-50 text-slate-800 min-h-screen">
  <!-- Login Overlayï¼ˆSchoolCalæ–¹å¼ï¼šè¨­å®šç”»é¢ãªã—ã€‚ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€è‡ªå‹•ã§ã‚¯ãƒ©ã‚¦ãƒ‰å…±æœ‰ï¼‰ -->
  <div id="login-overlay" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-slate-950/60"></div>
    <div class="relative max-w-md mx-auto mt-16 px-4">
      <div class="bg-white rounded-3xl border border-slate-200 shadow-2xl overflow-hidden">
        <div class="p-5 border-b border-slate-200 flex items-center gap-3">
          <div class="w-12 h-12 rounded-2xl bg-blue-600 text-white grid place-items-center font-black">â˜</div>
          <div class="min-w-0">
            <div class="text-lg font-black">ã‚¯ãƒ©ã‚¦ãƒ‰å…±æœ‰ãƒ­ã‚°ã‚¤ãƒ³</div>
            <div class="text-xs font-bold text-slate-500">ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€è‡ªå‹•ã§åŒæœŸã—ã¾ã™</div>
          </div>
        </div>
        <div class="p-5 space-y-4">
          <div>
            <div class="text-[11px] font-black text-slate-400 tracking-widest uppercase">ID</div>
            <input id="login-email" class="mt-2 w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 font-bold outline-none focus:ring-2 focus:ring-blue-500" placeholder="bus@otakisho.local" />
          </div>
          <div>
            <div class="text-[11px] font-black text-slate-400 tracking-widest uppercase">Password</div>
            <input id="login-password" type="password" class="mt-2 w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 font-bold outline-none focus:ring-2 focus:ring-blue-500" placeholder="otakisho" />
          </div>

          <div id="login-error" class="hidden px-3 py-2 rounded-2xl bg-rose-50 border border-rose-100 text-rose-700 text-xs font-black"></div>

          <button id="btn-login" class="tap w-full px-6 py-3 rounded-2xl bg-slate-900 text-white font-black shadow-xl hover:bg-black">
            ãƒ­ã‚°ã‚¤ãƒ³
          </button>

          <div class="text-[11px] font-bold text-slate-500">
            â€» Firebase Auth ã« <span class="font-black">bus@otakisho.local / otakisho</span> ãŒä½œæˆæ¸ˆã¿<br/>
            Â© 2026 Takayuki WAYAMA
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cloud Error Overlayï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰å¿…é ˆï¼šå¤±æ•—æ™‚ã«ãƒ­ãƒ¼ã‚«ãƒ«ã¸é»™ã£ã¦è½ã¡ãªã„ï¼‰ -->
  <div id="cloud-error-overlay" class="fixed inset-0 z-[55] hidden">
    <div class="absolute inset-0 bg-slate-950/60"></div>
    <div class="relative max-w-2xl mx-auto mt-14 px-4">
      <div class="bg-white rounded-3xl border border-slate-200 shadow-2xl overflow-hidden">
        <div class="p-5 border-b border-slate-200 flex items-center gap-3">
          <div class="w-12 h-12 rounded-2xl bg-rose-600 text-white grid place-items-center font-black">!</div>
          <div class="min-w-0">
            <div class="text-lg font-black">ã‚¯ãƒ©ã‚¦ãƒ‰æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ</div>
            <div class="text-xs font-bold text-slate-500">ã“ã®ã‚¢ãƒ—ãƒªã¯ã‚¯ãƒ©ã‚¦ãƒ‰å…±æœ‰å‰æã§ã™ã€‚ä¸‹è¨˜ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>
          </div>
        </div>
        <div class="p-5 space-y-3 text-sm">
          <div id="cloud-error-msg" class="px-3 py-2 rounded-2xl bg-rose-50 border border-rose-100 text-rose-700 font-black"></div>
          <ul class="list-disc pl-5 text-slate-700 font-bold space-y-1">
            <li>Firestore Rules ãŒ <span class="font-black">bus@otakisho.local</span> ã« read/write ã‚’è¨±å¯ã—ã¦ã„ã‚‹ã‹</li>
            <li>Authenticationï¼ˆEmail/Passwordï¼‰ãŒæœ‰åŠ¹ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆæ¸ˆã¿ã‹</li>
            <li>Authorized domains ã« GitHub Pages ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿½åŠ ã—ãŸã‹</li>
            <li>ä¸‹ã®ã‚³ãƒ¼ãƒ‰å†… <span class="font-black">PRESET_FIREBASE_CONFIG</span> ãŒæ­£ã—ã„ã‹</li>
          </ul>
          <button id="btn-cloud-error-close" class="tap px-5 py-3 rounded-2xl bg-slate-900 text-white font-black shadow-xl hover:bg-black">
            é–‰ã˜ã‚‹ï¼ˆç¢ºèªã—ãŸã‚‰å†èª­ã¿è¾¼ã¿ï¼‰
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- â˜…å·®ã—æ›¿ãˆæ¸ˆã¿ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šæ—¥ä»˜ã‚’ã‚¿ã‚¤ãƒˆãƒ«å·¦ï¼ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã¯2ã€œ3è¡Œã«æŠ˜ã‚Šè¿”ã—OK -->
  <header class="no-print sticky top-0 z-40 bg-white/75 backdrop-blur-md border-b border-slate-200">
    <div class="max-w-[1400px] mx-auto px-3 py-2">
      <div class="flex flex-wrap items-center gap-2">
        <!-- æ—¥ä»˜ï¼šã‚¿ã‚¤ãƒˆãƒ«ã®å·¦ -->
        <div class="shrink-0">
          <div class="flex items-center gap-2 bg-slate-100 rounded-2xl p-2 border border-slate-200">
            <button id="btn-prev-day" class="tap px-3 py-2 rounded-xl bg-white border border-slate-200 shadow-sm text-xs font-black hover:bg-slate-50" title="å‰æ—¥">â—€</button>
            <input id="date-picker" type="date" class="bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm font-black outline-none focus:ring-2 focus:ring-blue-500" />
            <button id="btn-next-day" class="tap px-3 py-2 rounded-xl bg-white border border-slate-200 shadow-sm text-xs font-black hover:bg-slate-50" title="ç¿Œæ—¥">â–¶</button>
          </div>
        </div>

        <!-- ã‚¿ã‚¤ãƒˆãƒ«ï¼šæ®‹ã‚Šå¹…ã‚’ä½¿ã„ã€ç‹­ã„ã¨æŠ˜ã‚Šè¿”ã— -->
        <div class="flex items-center gap-2 min-w-[220px] flex-1">
          <div class="w-10 h-10 rounded-2xl bg-blue-600 shadow-lg shadow-blue-100 grid place-items-center shrink-0">
            <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                d="M4 17V7a2 2 0 0 1 2-2h9.5a2 2 0 0 1 1.4.6L20 8.7a2 2 0 0 1 .6 1.4V17a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2Z"/>
              <path stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" d="M4 10h16"/>
            </svg>
          </div>

          <div class="min-w-0 leading-tight">
            <div class="text-base md:text-lg font-black tracking-tight truncate">
              å¤§å¤šå–œå°å­¦æ ¡ ã‚¹ã‚¯ãƒ¼ãƒ«ãƒã‚¹ä¹—è»Šç¢ºèª
            </div>
            <div class="text-[11px] font-bold text-slate-400 truncate">Â©2026 Takayuki WAYAMA</div>
          </div>
        </div>

        <!-- å³ï¼šãƒ”ãƒ«ï¼‹å…¨ç”»é¢ï¼ˆç‹­ã„ã¨æ¬¡è¡Œã¸ï¼‰ -->
        <div class="shrink-0 flex items-center gap-2">
          <div id="cloud-pill" class="px-3 py-2 rounded-2xl border text-xs font-black bg-white border-slate-200 text-slate-500 whitespace-nowrap">â˜ æœªæ¥ç¶š</div>
          <div id="auth-pill" class="px-3 py-2 rounded-2xl border text-xs font-black bg-white border-slate-200 text-slate-500 whitespace-nowrap">ğŸ‘¤ æœªãƒ­ã‚°ã‚¤ãƒ³</div>
          <button id="btn-fullscreen" class="tap px-3 py-2 rounded-2xl bg-slate-900 text-white text-xs font-black shadow-lg hover:bg-black whitespace-nowrap">å…¨ç”»é¢</button>
        </div>

        <!-- ã‚¿ãƒ–ï¼šã‚¹ãƒãƒ›/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã¯æ¬¡ã®è¡Œã«è½ã¨ã—ã¦OKï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯ï¼‰ -->
        <nav class="w-full md:w-auto md:ml-auto">
          <div class="flex bg-slate-100 p-1 rounded-2xl border border-slate-200 flex-nowrap whitespace-nowrap overflow-x-auto">
            <button class="px-4 py-2 rounded-xl text-xs md:text-sm transition-all tab-active" id="tab-check" onclick="UI.switchTab('check')">æ‹…ä»»ãƒã‚§ãƒƒã‚¯</button>
            <button class="px-4 py-2 rounded-xl text-xs md:text-sm transition-all text-slate-500" id="tab-monitor" onclick="UI.switchTab('monitor')">å…¨æ ¡ãƒ¢ãƒ‹ã‚¿</button>
            <button class="px-4 py-2 rounded-xl text-xs md:text-sm transition-all text-slate-500" id="tab-print" onclick="UI.switchTab('print')">å°åˆ·</button>
            <button class="px-4 py-2 rounded-xl text-xs md:text-sm transition-all text-slate-500" id="tab-settings" onclick="UI.switchTab('settings')">åç°¿/è¨­å®š</button>
          </div>
        </nav>
      </div>
    </div>
  </header>

  <main id="main-shell" class="print-shell max-w-[1400px] mx-auto px-4 py-6 space-y-6">
    <!-- Overview -->
    <section id="section-overview" class="no-print grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="bg-white border border-slate-200 rounded-3xl p-5 shadow-sm">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-[11px] font-black text-slate-400 tracking-widest uppercase">æ—¥ä»˜</div>
            <div class="text-2xl font-black tracking-tight" id="today-label">----</div>
            <div class="text-xs font-bold text-slate-500 mt-1" id="run-label">â€» ï¼”æ™‚é–“ç›®ã¾ã§ã«ä¹—è»Šç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</div>
          </div>
          <div class="w-12 h-12 rounded-2xl bg-blue-50 border border-blue-100 grid place-items-center">
            <svg class="w-7 h-7 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0-4-4m4 4-4 4M4 17h12m0 0-4 4m4-4-4-4"/>
            </svg>
          </div>
        </div>
        <div class="mt-4 flex flex-wrap gap-2" id="class-progress-badges"></div>
      </div>

      <div class="bg-white border border-slate-200 rounded-3xl p-5 shadow-sm">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-[11px] font-black text-slate-400 tracking-widest uppercase">å…¨æ ¡ ä¹—è»Šï¼ˆãƒã‚§ãƒƒã‚¯æ¸ˆï¼‰</div>
            <div class="text-4xl font-black tracking-tight text-slate-900" id="school-ride-count">--</div>
            <div class="text-xs font-bold text-slate-500 mt-1" id="school-ride-sub">--</div>
          </div>
          <div class="w-12 h-12 rounded-2xl bg-emerald-50 border border-emerald-100 grid place-items-center">
            <svg class="w-7 h-7 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" d="M20 7 10 17l-5-5"/>
            </svg>
          </div>
        </div>
        <div class="mt-4 flex flex-wrap gap-2" id="bus-summary-chips"></div>
      </div>
    </section>

    <!-- 1) Check -->
    <section id="section-check" class="space-y-4">
      <div class="no-print bg-white border border-slate-200 rounded-3xl p-4 shadow-sm flex flex-wrap items-center gap-3">
        <div class="flex items-center gap-2">
          <span class="text-[11px] font-black text-slate-400 tracking-widest uppercase">å­¦ç´š</span>
          <select id="class-filter" class="bg-slate-100 border border-slate-200 px-4 py-2 rounded-2xl font-black text-blue-700 outline-none focus:ring-2 focus:ring-blue-500"></select>
        </div>

        <div class="flex items-center gap-2">
          <span class="text-[11px] font-black text-slate-400 tracking-widest uppercase">æ¤œç´¢</span>
          <input id="student-search" placeholder="æ°å / ãƒã‚¹åœ" class="bg-slate-100 border border-slate-200 px-4 py-2 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-blue-500 w-56" />
        </div>

        <div class="flex items-center gap-2" id="class-bus-summary"></div>

        <div class="ml-auto flex flex-wrap items-center gap-2">
          <button id="btn-class-done" class="tap px-5 py-2 rounded-2xl text-sm font-black border-2 border-blue-600 text-blue-700 hover:bg-blue-50">å­¦ç´šç¢ºèªã‚’å®Œäº†</button>
          <button id="btn-class-unlock" class="tap px-4 py-2 rounded-2xl text-xs font-black bg-slate-100 border border-slate-200 hover:bg-slate-200 hidden">ãƒ­ãƒƒã‚¯è§£é™¤</button>

          <button id="btn-mark-all-ride" class="tap px-4 py-2 rounded-2xl text-xs font-black bg-blue-600 text-white shadow-lg shadow-blue-100 hover:bg-blue-700">å…¨å“¡ ä¹—è»Š</button>
          <button id="btn-mark-all-clear" class="tap px-4 py-2 rounded-2xl text-xs font-black bg-slate-200 text-slate-700 hover:bg-slate-300">å…¨å“¡ ã‚¯ãƒªã‚¢</button>
        </div>
      </div>

      <div id="check-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-3"></div>

      <div class="no-print text-xs text-slate-500 font-bold">
        ä½¿ã„æ–¹ï¼š<span class="font-black text-slate-700">æœªãƒã‚§ãƒƒã‚¯</span>ã‹ã‚‰<span class="font-black text-slate-700">ä¹—è»Š</span>ã ã‘ã‚’ã‚¿ãƒƒãƒ—ã§è‰²ä»˜ãã«ã€‚è¨­å®šã—ãŸå­¦å¹´ã¯ <span class="font-black text-slate-700">éƒ¨æ´»ã›ãš</span> ãƒœã‚¿ãƒ³ãŒå‡ºã¾ã™ï¼ˆå°åˆ·ã§ã‚°ãƒ¬ãƒ¼è¡¨ç¤ºï¼‰ã€‚å­¦ç´šç¢ºèªå®Œäº†ã§ã€Œãã®å­¦ç´šã¯ç¢ºèªæ¸ˆã¿ã€ã«ãªã‚Šã¾ã™ã€‚
      </div>
    </section>

    <!-- 2) Monitor -->
    <section id="section-monitor" class="hidden space-y-2">
      <div class="no-print flex flex-wrap items-center gap-2">
        <div id="monitor-summary" class="flex-1 min-w-[260px] bg-white border border-slate-200 rounded-2xl px-3 py-2 shadow-sm flex flex-wrap items-center gap-2"></div>

        <div class="flex items-center gap-2">
          <select id="monitor-filter" class="bg-white border border-slate-200 px-3 py-2 rounded-2xl text-xs font-black outline-none">
            <option value="all">ã™ã¹ã¦</option>
            <option value="pending">æœªå®Œäº†å­¦ç´šã®ã¿</option>
            <option value="done">å®Œäº†å­¦ç´šã®ã¿</option>
          </select>
          <button id="btn-monitor-refresh" class="tap px-4 py-2 rounded-2xl bg-slate-900 text-white text-xs font-black hover:bg-black">æ›´æ–°</button>
        </div>
      </div>

      <div id="monitor-fit-root" class="no-print bg-white border border-slate-200 rounded-2xl p-0 shadow-sm overflow-hidden">
        <div id="monitor-fit" class="origin-top-left">
          <div id="monitor-grid" class="flex flex-row flex-nowrap gap-2"></div>
        </div>
      </div>

      <div class="no-print text-[11px] font-bold text-slate-500">
        â€» ç”»é¢ã«åã¾ã‚‰ãªã„å ´åˆã¯è‡ªå‹•ç¸®å°ã—ã¦å…¨å“¡è¡¨ç¤ºã—ã¾ã™ï¼ˆ1ã‚¯ãƒ©ã‚¹æœ€å¤§20äººæƒ³å®šï¼‰ã€‚
      </div>
    </section>

    <!-- 3) Print -->
    <section id="section-print" class="hidden space-y-4">
      <div class="no-print bg-white border border-slate-200 rounded-3xl p-5 shadow-sm flex flex-wrap items-center gap-3">
        <div class="mr-auto">
          <div class="text-lg font-black text-slate-800">å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        </div>

        <div class="flex items-center gap-2">
          <span class="text-[11px] font-black text-slate-400 tracking-widest uppercase">å½¢å¼</span>
          <select id="print-mode" class="bg-slate-100 border border-slate-200 px-4 py-2 rounded-2xl font-black outline-none">
            <option value="bus">ä¹—è»Šç¢ºèªç”¨</option>
            <option value="class">å­¦ç´šæ§ãˆç”¨</option>
          </select>
        </div>

        <button onclick="window.print()" class="tap px-8 py-3 rounded-2xl bg-slate-900 text-white font-black shadow-xl hover:bg-black flex items-center">
          <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
            <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M6 14h12v8H6z"/>
          </svg>
          å°åˆ·ã™ã‚‹
        </button>
      </div>

      <div id="print-content" class="bg-white rounded-3xl border border-slate-200 shadow-inner p-6"></div>
    </section>

    <!-- 4) Settings -->
    <section id="section-settings" class="hidden space-y-6 no-print">
      <!-- SchoolCalæ–¹å¼ï¼šFirebaseè¨­å®šè²¼ã‚Šä»˜ã‘ç­‰ã¯ç½®ã‹ãªã„ã€‚ãƒ­ã‚°ã‚¤ãƒ³ï¼†ã‚¯ãƒ©ã‚¦ãƒ‰å…±æœ‰ã®ã¿è¡¨ç¤º -->
      <div class="bg-white border border-slate-200 rounded-3xl p-6 shadow-sm">
        <div class="flex flex-wrap items-start gap-4">
          <div class="mr-auto">
            <div class="text-xl font-black text-slate-800">ã‚¯ãƒ©ã‚¦ãƒ‰å…±æœ‰ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ï¼‰</div>
            <div class="text-xs font-bold text-slate-500 mt-1">
              â€» ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€è‡ªå‹•çš„ã«åŒæœŸã—ã¾ã™ã€‚
            </div>
          </div>
          <div class="flex gap-2">
            <button id="btn-logout" class="tap px-5 py-2 rounded-2xl bg-slate-100 border border-slate-200 text-sm font-black hover:bg-slate-200">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            <button id="btn-save-config" class="tap px-5 py-2 rounded-2xl bg-blue-600 text-white text-sm font-black shadow-lg shadow-blue-100 hover:bg-blue-700">è¨­å®šã‚’ä¿å­˜</button>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-5">
          <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
            <div class="text-[11px] font-black text-slate-400 tracking-widest uppercase">è¡¨ç¤ºåï¼ˆæ›´æ–°è€…è¡¨ç¤ºï¼‰</div>
            <input id="cfg-display-name" class="mt-2 w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 font-bold outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹ï¼šæ‹…ä»»å / è·å“¡å®¤" />
          </div>

          <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
            <div class="text-[11px] font-black text-slate-400 tracking-widest uppercase">ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹</div>
            <div class="mt-2 space-y-2">
              <div id="settings-auth" class="px-3 py-2 rounded-2xl border text-xs font-black bg-white border-slate-200 text-slate-600">--</div>
              <div id="settings-cloud" class="px-3 py-2 rounded-2xl border text-xs font-black bg-white border-slate-200 text-slate-600">--</div>
            </div>
            <div class="text-[11px] font-bold text-slate-500 mt-2">
              â€» å…±æœ‰ã¯ Firestoreï¼ˆschool_busï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™
            </div>
          </div>

          <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
            <div class="text-[11px] font-black text-slate-400 tracking-widest uppercase">ä¿å­˜å…ˆ</div>
            <div class="mt-2 space-y-2 text-xs font-bold text-slate-700">
              <div>School IDï¼š<span class="font-black" id="settings-schoolid">--</span></div>
              <div>Project IDï¼š<span class="font-black" id="settings-projectid">--</span></div>
            </div>
            <div class="text-[11px] font-bold text-slate-500 mt-2">
              â€» firebaseConfigã¯ã‚³ãƒ¼ãƒ‰å†…ã«åŸ‹ã‚è¾¼ã¿æ¸ˆã¿
            </div>
          </div>
        </div>
      </div>

      <!-- Bus Names -->
      <div class="bg-white border border-slate-200 rounded-3xl p-6 shadow-sm">
        <div class="flex flex-wrap items-center gap-3">
          <div class="mr-auto">
            <div class="text-xl font-black text-slate-800">ãƒã‚¹åç§°ï¼ˆè¡¨ç¤ºè¨­å®šï¼‰</div>
            <div class="text-xs font-bold text-slate-500 mt-1">â€» å¤‰æ›´ã™ã‚‹ã¨ã€åç°¿ã®ã€Œåˆ©ç”¨ãƒã‚¹ã€è¡¨è¨˜ã‚‚è‡ªå‹•ã§ç½®ãæ›ãˆã¾ã™ï¼ˆä¿å­˜æ™‚ï¼‰ã€‚</div>
          </div>
          <button id="btn-reset-busnames" class="tap px-4 py-2 rounded-2xl bg-white border border-slate-200 text-xs font-black text-slate-700 hover:bg-slate-50">åˆæœŸå€¤ã«æˆ»ã™</button>
        </div>
        <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div>
            <div class="text-[10px] font-black text-slate-400 uppercase ml-1">ãƒã‚¹1ï¼ˆä¸Šç€‘ï¼‰</div>
            <input id="cfg-bus-0" class="mt-1 w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 font-bold outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <div class="text-[10px] font-black text-slate-400 uppercase ml-1">ãƒã‚¹2ï¼ˆç·å…ƒï¼‰</div>
            <input id="cfg-bus-1" class="mt-1 w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 font-bold outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <div class="text-[10px] font-black text-slate-400 uppercase ml-1">ãƒã‚¹3ï¼ˆå¸‚éƒ¨ãƒ»ç”°ä»£ï¼‰</div>
            <input id="cfg-bus-2" class="mt-1 w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 font-bold outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
        </div>
        <div class="text-[11px] font-bold text-slate-500 mt-3">â€» ä¿å­˜ã¯ã€Œã‚¯ãƒ©ã‚¦ãƒ‰å…±æœ‰ã€ã‚«ãƒ¼ãƒ‰å†…ã® <span class="font-black text-slate-800">è¨­å®šã‚’ä¿å­˜</span> ãƒœã‚¿ãƒ³ã§ç¢ºå®šã—ã¾ã™ã€‚</div>
      </div>

      
      <!-- No-Club Toggle Grades -->
      <div class="bg-white border border-slate-200 rounded-3xl p-6 shadow-sm">
        <div class="flex flex-wrap items-center gap-3">
          <div class="mr-auto">
            <div class="text-xl font-black text-slate-800">ã€Œéƒ¨æ´»ã›ãšä¹—è»Šã€è¡¨ç¤ºå­¦å¹´</div>
            <div class="text-xs font-bold text-slate-500 mt-1">â€» æ‹…ä»»ãƒã‚§ãƒƒã‚¯ã®ã‚«ãƒ¼ãƒ‰ã«ã€Œéƒ¨æ´»ã›ãšä¹—è»Šã€ãƒˆã‚°ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹å­¦å¹´ã‚’é¸ã³ã¾ã™ï¼ˆå°åˆ·ã§è©²å½“å…ç«¥ã‚’ã‚°ãƒ¬ãƒ¼è¡¨ç¤ºï¼‰ã€‚</div>
          </div>
        </div>
        <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-2">
          <label class="flex items-center gap-2 px-3 py-2 rounded-2xl bg-slate-50 border border-slate-200 font-black text-sm"><input id="cfg-noclub-g1" type="checkbox" class="w-4 h-4" />1å¹´</label>
          <label class="flex items-center gap-2 px-3 py-2 rounded-2xl bg-slate-50 border border-slate-200 font-black text-sm"><input id="cfg-noclub-g2" type="checkbox" class="w-4 h-4" />2å¹´</label>
          <label class="flex items-center gap-2 px-3 py-2 rounded-2xl bg-slate-50 border border-slate-200 font-black text-sm"><input id="cfg-noclub-g3" type="checkbox" class="w-4 h-4" />3å¹´</label>
          <label class="flex items-center gap-2 px-3 py-2 rounded-2xl bg-slate-50 border border-slate-200 font-black text-sm"><input id="cfg-noclub-g4" type="checkbox" class="w-4 h-4" />4å¹´</label>
          <label class="flex items-center gap-2 px-3 py-2 rounded-2xl bg-slate-50 border border-slate-200 font-black text-sm"><input id="cfg-noclub-g5" type="checkbox" class="w-4 h-4" />5å¹´</label>
          <label class="flex items-center gap-2 px-3 py-2 rounded-2xl bg-slate-50 border border-slate-200 font-black text-sm"><input id="cfg-noclub-g6" type="checkbox" class="w-4 h-4" />6å¹´</label>
        </div>
      </div>

<!-- Roster -->
      <div class="bg-white border border-slate-200 rounded-3xl p-6 shadow-sm">
        <div class="flex flex-wrap items-center gap-3">
          <div class="mr-auto">
            <div class="text-xl font-black text-slate-800">åç°¿ï¼ˆåŸºæœ¬è¨­å®šï¼‰</div>
            <div class="text-xs font-bold text-slate-500 mt-1">â€» æ—¥ã€…ã®çŠ¶æ…‹ã¯æ—¥ä»˜ã”ã¨ã«ä¿å­˜ã€‚</div>
          </div>

          <div class="flex flex-wrap gap-2">
            <button id="btn-export-json" class="tap px-4 py-2 rounded-2xl bg-white border border-slate-200 text-xs font-black text-blue-700 hover:bg-blue-50">JSON æ›¸ãå‡ºã—</button>
            <button id="btn-export-csv" class="tap px-4 py-2 rounded-2xl bg-white border border-slate-200 text-xs font-black text-emerald-700 hover:bg-emerald-50">CSV æ›¸ãå‡ºã—</button>

            <label class="tap px-4 py-2 rounded-2xl bg-white border border-slate-200 text-xs font-black text-slate-700 hover:bg-slate-50 cursor-pointer">
              CSV èª­ã¿è¾¼ã¿
              <input id="file-import-csv" type="file" accept=".csv,text/csv" class="hidden" />
            </label>

            <button id="btn-factory-reset" class="tap px-4 py-2 rounded-2xl bg-rose-50 border border-rose-100 text-xs font-black text-rose-700 hover:bg-rose-100">å…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
          </div>
        </div>

        <div class="mt-5 bg-slate-50 border border-slate-200 rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-3">
            <span id="editor-dot" class="w-2 h-8 bg-blue-600 rounded-full"></span>
            <div class="text-lg font-black" id="editor-title">å…ç«¥ã®è¿½åŠ </div>
            <div class="ml-auto text-xs font-bold text-slate-500" id="roster-count-label">å…¨ -- å</div>
          </div>

          <form id="student-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-7 gap-3">
            <input type="hidden" id="edit-id" />
            <div>
              <div class="text-[10px] font-black text-slate-400 uppercase ml-1">ã‚¯ãƒ©ã‚¹ (ä¾‹: ï¼‘å¹´ã€ï¼–å¹´ï¼’çµ„)</div>
              <input id="input-class" class="mt-1 w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 font-bold outline-none focus:ring-2 focus:ring-blue-500" placeholder="" required />
            </div>
            <div>
              <div class="text-[10px] font-black text-slate-400 uppercase ml-1">å‡ºå¸­ç•ªå·</div>
              <input id="input-num" type="number" class="mt-1 w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 font-bold outline-none focus:ring-2 focus:ring-blue-500" placeholder="" required />
            </div>
            <div>
              <div class="text-[10px] font-black text-slate-400 uppercase ml-1">æ°å</div>
              <input id="input-name" class="mt-1 w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 font-bold outline-none focus:ring-2 focus:ring-blue-500" placeholder="æ°å" required />
            </div>
            <div>
              <div class="text-[10px] font-black text-slate-400 uppercase ml-1">åˆ©ç”¨ãƒã‚¹</div>
              <select id="input-bus" class="mt-1 w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 font-bold outline-none focus:ring-2 focus:ring-blue-500">
                                <!-- options injected by JS -->
              </select>
            </div>
            <div class="lg:col-span-2">
              <div class="text-[10px] font-black text-slate-400 uppercase ml-1">ãƒã‚¹åœ</div>
              <input id="input-stop" class="mt-1 w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 font-bold outline-none focus:ring-2 focus:ring-blue-500" placeholder="ãƒã‚¹åœ" required />
            </div>
            <div class="flex items-end gap-2">
              <button id="btn-save" type="submit" class="tap w-full px-5 py-3 rounded-2xl bg-blue-600 text-white font-black shadow-lg shadow-blue-100 hover:bg-blue-700">è¿½åŠ </button>
              <button id="btn-cancel-edit" type="button" class="tap hidden px-5 py-3 rounded-2xl bg-slate-200 text-slate-700 font-black hover:bg-slate-300">å–æ¶ˆ</button>
            </div>
          </form>
        </div>

        <div class="mt-5 border border-slate-200 rounded-2xl overflow-hidden">
          <div class="px-4 py-3 bg-white border-b border-slate-200 flex items-center gap-2">
            <div class="text-sm font-black text-slate-700">ç™»éŒ²æ¸ˆã¿åç°¿</div>
            <div class="ml-auto text-xs font-bold text-slate-400">â€» ä¸¦ã³ï¼šã‚¯ãƒ©ã‚¹â†’ç•ªå·</div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead class="bg-slate-50 text-slate-500 text-[10px] font-black uppercase tracking-widest">
                <tr>
                  <th class="p-3">ã‚¯ãƒ©ã‚¹</th>
                  <th class="p-3">ç•ªå·</th>
                  <th class="p-3">æ°å</th>
                  <th class="p-3">ãƒã‚¹</th>
                  <th class="p-3">ãƒã‚¹åœ</th>
                  <th class="p-3 text-center">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="settings-list-body" class="divide-y divide-slate-100 font-medium text-sm"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div class="fixed bottom-4 left-0 right-0 z-50 pointer-events-none">
    <div id="toast" class="hidden toast-in mx-auto max-w-lg bg-slate-900 text-white px-4 py-3 rounded-2xl shadow-2xl pointer-events-auto">
      <div class="text-sm font-black" id="toast-msg">--</div>
    </div>
  </div>

<script>
/* =========================
   Bus Checker (ä¸‹æ ¡ã®ã¿) v12.3-schoolcal-cloud
   - SchoolCalæ–¹å¼ï¼šFirebaseè¨­å®šç”»é¢ãªã— / ãƒ­ã‚°ã‚¤ãƒ³å¾Œ è‡ªå‹•ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼ˆFirestoreï¼‰
   - ã‚¯ãƒ©ã‚¦ãƒ‰å¿…é ˆï¼šå¤±æ•—æ™‚ã«ãƒ­ãƒ¼ã‚«ãƒ«ã¸é»™ã£ã¦è½ã¡ãšã€åŸå› è¡¨ç¤º
========================= */

/* â˜…ã“ã“ã ã‘å·®ã—æ›¿ãˆï¼ˆFirebase Console ã® Web config ã‚’ã‚³ãƒ”ãƒšï¼‰ */
const PRESET_FIREBASE_CONFIG = {
  apiKey: "AIzaSyAMM4vSEptczXS7VFh5Fc8xvWXigCbTQXU",
  authDomain: "schoolbus-cc762.firebaseapp.com",
  projectId: "schoolbus-cc762",
  storageBucket: "schoolbus-cc762.firebasestorage.app",
  messagingSenderId: "585729970166",
  appId: "1:585729970166:web:556c33a05e58e48f9481d7",
  measurementId: "G-D0F2MEDCHE"
};


/* å…±æœ‰å˜ä½ï¼ˆå­¦æ ¡IDï¼‰ */
const PRESET_SCHOOL_ID = "otaki-es";

const APP = {
  version: "v12.4-schoolcal-cloud",
  storageKey: "busCheckerV123",
  defaultBusTypes: ["ä¸Šç€‘ãƒã‚¹","ç·å…ƒãƒã‚¹","å¸‚éƒ¨ãƒ»ç”°ä»£ãƒã‚¹"],
  busTypes: ["ä¸Šç€‘ãƒã‚¹","ç·å…ƒãƒã‚¹","å¸‚éƒ¨ãƒ»ç”°ä»£ãƒã‚¹"],
  statuses: [
    { key:"none",   label:"æœªãƒã‚§ãƒƒã‚¯", chip:"chip-none",   short:"æœª" },
    { key:"ride",   label:"ä¹—è»Š",       chip:"chip-ride",   short:"ä¹—" },
    { key:"absent", label:"æ¬ å¸­",       chip:"chip-absent", short:"æ¬ " },
    { key:"pickup", label:"é€è¿",       chip:"chip-pickup", short:"é€" },
    { key:"other",  label:"ãã®ä»–",     chip:"chip-other",  short:"ä»–" }
  ]
};

const $ = (sel)=>document.querySelector(sel);
function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

// ---- Print / Class helpers (added) ----
function toHalfWidthDigits(str){
  return String(str ?? "").replace(/[ï¼-ï¼™]/g, (d)=>String.fromCharCode(d.charCodeAt(0) - 0xFF10 + 0x30));
}
function formatClassLabel(cls){
  const s = toHalfWidthDigits(cls);
  let m = s.match(/^\s*(\d+)\s*[-â€ãƒ¼ï¼]\s*(\d+)\s*$/);
  if(m) return `${m[1]}å¹´${m[2]}çµ„`;
  m = s.match(/^\s*(\d+)\s*å¹´\s*(\d+)\s*çµ„\s*$/);
  if(m) return `${m[1]}å¹´${m[2]}çµ„`;
  m = s.match(/^\s*(\d+)\s*å¹´\s*$/);
  if(m) return `${m[1]}å¹´`;
  return String(cls ?? "");
}
// text length based font size fitting (approx.)
function fitFontPt(text, basePt, maxChars, minPt){
  const t = String(text ?? "");
  if(!t) return basePt;
  const len = Math.max(1, [...t].length); // count by code points
  const maxC = Math.max(1, Number(maxChars) || len);
  const base = Number(basePt) || 8;
  const min = Number(minPt) || 6;
  if(len <= maxC) return base;
  const ratio = maxC / len;
  const pt = base * ratio * 0.98;
  return Math.max(min, Math.round(pt * 10) / 10);
}
function gradeFromClass(cls){
  const s = toHalfWidthDigits(cls);
  let m = s.match(/^\s*(\d)\s*[-â€ãƒ¼ï¼]/);
  if(m) return m[1];
  m = s.match(/^\s*(\d)\s*å¹´/);
  if(m) return m[1];
  m = s.match(/(\d)\s*å¹´/);
  if(m) return m[1];
  return "";
}
function shouldShowNoClubToggle(cls){
  const g = gradeFromClass(cls);
  const list = DB?.config?.noClubGrades || [];
  return g && Array.isArray(list) && list.map(String).includes(String(g));
}

function nowTs(){ return Date.now(); }
function dateKey(d=new Date()){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function addDays(key, delta){
  const [y,m,d]=key.split("-").map(Number);
  const dt=new Date(y,m-1,d);
  dt.setDate(dt.getDate()+delta);
  return dateKey(dt);
}
function jpDateLabel(key){
  const [y,m,d]=key.split("-").map(Number);
  const dt=new Date(y,m-1,d);
  const days=["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  return `${y}å¹´ ${m}æœˆ${d}æ—¥ (${days[dt.getDay()]})`;
}
function fmtTime(ts){
  if(!ts) return "--";
  const dt=new Date(ts);
  const hh=String(dt.getHours()).padStart(2,"0");
  const mm=String(dt.getMinutes()).padStart(2,"0");
  const ss=String(dt.getSeconds()).padStart(2,"0");
  return `${hh}:${mm}:${ss}`;
}
function sanitizeBusTypes(arr, fallback){
  const fb = Array.isArray(fallback) ? fallback : (APP.defaultBusTypes || ["ä¸Šç€‘ãƒã‚¹","ç·å…ƒãƒã‚¹","å¸‚éƒ¨ãƒ»ç”°ä»£ãƒã‚¹"]);
  const a = Array.isArray(arr) ? arr.map(x=>String(x||"").trim()) : [];
  const out = [0,1,2].map(i => a[i] || fb[i] || (APP.defaultBusTypes?.[i] || ""));
  return out.map((x,i)=>x || (fb[i] || (APP.defaultBusTypes?.[i] || "")));
}

function busSlot(busName){
  const b=String(busName||"").trim();
  const types=APP.busTypes || [];
  const idx = types.findIndex(x=>String(x||"").trim()===b);
  if(idx>=0) return idx;
  // keyword fallbackï¼ˆæ—§ãƒ‡ãƒ¼ã‚¿/æƒ³å®šå¤–ã«ã‚‚å¼·ãï¼‰
  if(b.includes("ä¸Šç€‘")) return 0;
  if(b.includes("ç·å…ƒ")) return 1;
  if(b.includes("å¸‚éƒ¨") || b.includes("ç”°ä»£")) return 2;
  return -1;
}

function busClass(busName){
  const slot = busSlot(busName);
  if(slot===0) return "bus-u";
  if(slot===1) return "bus-s";
  if(slot===2) return "bus-t";
  return "bg-slate-100 text-slate-700 border border-slate-200";
}
function busShort(busName){ return String(busName||"").replace("ãƒã‚¹","").slice(0,2); }

function rideThemeForBus(busName){
  const slot = busSlot(busName);
  if(slot===0){
    return { card:"bg-blue-600 border-blue-700 shadow-lg shadow-blue-100", name:"text-white", sub:"text-blue-50", menu:"bg-white/15 border-white/20 text-white hover:bg-white/20", note:"text-white bg-white/15 border-white/20" };
  }
  if(slot===1){
    return { card:"bg-amber-400 border-amber-500 shadow-lg shadow-amber-100", name:"text-amber-950", sub:"text-amber-900", menu:"bg-white/40 border-white/40 text-amber-950 hover:bg-white/50", note:"text-amber-950 bg-white/35 border-white/40" };
  }
  if(slot===2){
    return { card:"bg-rose-600 border-rose-700 shadow-lg shadow-rose-100", name:"text-white", sub:"text-rose-50", menu:"bg-white/15 border-white/20 text-white hover:bg-white/20", note:"text-white bg-white/15 border-white/20" };
  }
  return { card:"bg-blue-600 border-blue-700 shadow-lg shadow-blue-100", name:"text-white", sub:"text-blue-50", menu:"bg-white/15 border-white/20 text-white hover:bg-white/20", note:"text-white bg-white/15 border-white/20" };
}
function rideRowThemeForBus(busName){
  const slot = busSlot(busName);
  if(slot===0) return "bg-blue-50 border-blue-100";
  if(slot===1) return "bg-amber-50 border-amber-100";
  if(slot===2) return "bg-rose-50 border-rose-100";
  return "bg-blue-50 border-blue-100";
}

function showToast(msg){
  const t=$("#toast");
  $("#toast-msg").textContent=msg;
  t.classList.remove("hidden");
  clearTimeout(showToast._to);
  showToast._to=setTimeout(()=>t.classList.add("hidden"), 2200);
}

function normalizeStatus(k){
  if(!k) return "none";
  if(k==="off") return "none";
  const ok = APP.statuses.some(x=>x.key===k);
  return ok ? k : "none";
}

/* -------------------------
   Local DBï¼ˆè¡¨ç¤ºåãªã©ç«¯æœ«ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿æŒï¼‰
------------------------- */
function defaultDB(){
  return {
    config:{
      displayName:"",
      busTypes: (APP.busTypes || APP.defaultBusTypes || ["ä¸Šç€‘ãƒã‚¹","ç·å…ƒãƒã‚¹","å¸‚éƒ¨ãƒ»ç”°ä»£ãƒã‚¹"]).slice(0,3),
      noClubGrades:["4","5","6"],
      schoolId: PRESET_SCHOOL_ID
    },
    roster:[
      { id: 1, class:"1-1", num:1, name:"ä½è—¤ å¤ªéƒ", bus:"ä¸Šç€‘ãƒã‚¹", stop:"ä¸Šç€‘é§…å‰" },
      { id: 2, class:"1-1", num:2, name:"éˆ´æœ¨ èŠ±å­", bus:"ç·å…ƒãƒã‚¹", stop:"ç·å…ƒå°å­¦æ ¡" },
      { id: 3, class:"2-1", num:1, name:"ç”°ä¸­ ä¸€éƒ", bus:"å¸‚éƒ¨ãƒ»ç”°ä»£ãƒã‚¹", stop:"å¸‚éƒ¨ãƒ»ç”°ä»£ä¸­å¤®" },
    ],
    daily:{}
  };
}
function loadDB(){
  try{
    const raw = localStorage.getItem(APP.storageKey);
    const base = defaultDB();
    if(raw){
      const obj=JSON.parse(raw);
      obj.config = { ...base.config, ...(obj.config||{}) };
      obj.config.busTypes = sanitizeBusTypes(obj.config.busTypes, base.config.busTypes);
      obj.roster ||= [];
      obj.daily ||= {};
      obj.config.schoolId = PRESET_SCHOOL_ID; // å¼·åˆ¶
      return obj;
    }
    return base;
  }catch(e){
    console.warn(e);
    return defaultDB();
  }
}
function saveDB(){ localStorage.setItem(APP.storageKey, JSON.stringify(DB)); }
let DB = loadDB();
APP.busTypes = sanitizeBusTypes(DB.config.busTypes, APP.defaultBusTypes);
DB.config.busTypes = APP.busTypes.slice();
saveDB();

/* -------------------------
   State
------------------------- */
const State = {
  tab:"check",
  date: dateKey(),
  cloudReady:false,
  backend:null,
  roster: DB.roster || [],
  dailyDoc: null,
  classLock:false,
  activeClass:"",
  monitorFilter:"all",
  printMode:"bus"
};

function sortClassKey(a,b){ return a.localeCompare(b, undefined, {numeric:true, sensitivity:"base"}); }

/* -------------------------
   Daily helpers
------------------------- */
function ensureDaily(dateK){
  DB.daily[dateK] ||= { states:{}, classDone:{}, updatedAt:0, updatedBy:"" };
  return DB.daily[dateK];
}
function getDailyState(dateK, studentId){
  const daily = State.dailyDoc || ensureDaily(dateK);
  const st = daily.states?.[studentId];
  if(st){
    return { ...st, status: normalizeStatus(st.status), noClub: !!st.noClub };
  }
  return { status:"none", note:"", ts:0, by:"", noClub:false };
}
function setDailyStateLocal(dateK, studentId, patch){
  const daily = ensureDaily(dateK);
  const prevRaw = daily.states[studentId] ? {...daily.states[studentId]} : { status:"none", note:"", ts:0, by:"", noClub:false };
  const prev = { ...prevRaw, status: normalizeStatus(prevRaw.status) };
  const next = { ...prev, ...patch, status: normalizeStatus(patch.status ?? prev.status), noClub: (patch.noClub ?? prev.noClub ?? false), ts: nowTs(), by:(DB.config.displayName || "â€”") };
  daily.states[studentId] = next;
  daily.updatedAt = nowTs();
  daily.updatedBy = DB.config.displayName || "â€”";
  saveDB();
  return { prev, next };
}
function setClassDoneLocal(dateK, className, done){
  const daily = ensureDaily(dateK);
  daily.classDone ||= {};
  daily.classDone[className]=!!done;
  daily.updatedAt = nowTs();
  daily.updatedBy = DB.config.displayName || "â€”";
  saveDB();
}

/* -------------------------
   Derived
------------------------- */
function derived(){
  const roster = State.roster || [];
  const classes = [...new Set(roster.map(s=>s.class))].sort(sortClassKey);

  const daily = State.dailyDoc || { states:{}, classDone:{}, updatedAt:0, updatedBy:"" };
  const classDone = daily.classDone || {};

  const rideCount = roster.filter(s => getDailyState(State.date, s.id).status === "ride").length;

  const busCounts = Object.fromEntries(APP.busTypes.map(b=>[b,0]));
  roster.forEach(s=>{
    if(getDailyState(State.date, s.id).status==="ride"){
      busCounts[s.bus]=(busCounts[s.bus]||0)+1;
    }
  });

  const doneCount = classes.filter(c=>classDone[c]===true).length;
  return { roster, classes, daily, classDone, rideCount, busCounts, doneCount };
}


function deriveBusTypesFromRoster(roster){
  const list = Array.isArray(roster) ? roster : [];
  const uniq = [...new Set(list.map(s=>String(s?.bus||"").trim()).filter(Boolean))];
  if(!uniq.length) return null;

  const slots = [null,null,null];
  let remaining = uniq.slice();

  const take = (pred, idx)=>{
    const i = remaining.findIndex(pred);
    if(i>=0){ slots[idx]=remaining[i]; remaining.splice(i,1); }
  };
  // æ—§åç§°ã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã¯è‡ªå‹•ã§ã‚¹ãƒ­ãƒƒãƒˆã«å¯„ã›ã‚‹
  take(b=>b.includes("ä¸Šç€‘"), 0);
  take(b=>b.includes("ç·å…ƒ"), 1);
  take(b=>b.includes("å¸‚éƒ¨") || b.includes("ç”°ä»£"), 2);

  for(let i=0;i<3;i++){
    if(!slots[i] && remaining.length) slots[i]=remaining.shift();
  }

  const base = sanitizeBusTypes(DB?.config?.busTypes, APP.defaultBusTypes);
  for(let i=0;i<3;i++){
    if(!slots[i]) slots[i]=base[i];
  }
  return sanitizeBusTypes(slots, base);
}
function syncBusTypesFromRoster(roster){
  const inferred = deriveBusTypesFromRoster(roster);
  if(!inferred) return;

  const current = sanitizeBusTypes(DB?.config?.busTypes, APP.defaultBusTypes);
  const uniq = [...new Set((Array.isArray(roster)?roster:[]).map(s=>String(s?.bus||"").trim()).filter(Boolean))];
  const needs = uniq.some(b=>b && !current.includes(b));

  if(needs){
    APP.busTypes = sanitizeBusTypes(inferred, APP.defaultBusTypes);
    DB.config.busTypes = APP.busTypes.slice();
    saveDB();
  }
}

function refreshBusSelectOptions(){
  const sel = $("#input-bus");
  if(!sel) return;
  const current = String(sel.value||"").trim();
  const list = (APP.busTypes || APP.defaultBusTypes || []).slice(0,3).filter(Boolean);
  if(current && !list.includes(current)) list.push(current);
  sel.innerHTML = list.map(b=>`<option value="${esc(b)}">${esc(b)}</option>`).join("");
  if(current) sel.value = current;
}

function mapBusToCurrent(busStr){
  const b = String(busStr||"").trim();
  if(!b) return "";
  const types = (APP.busTypes || APP.defaultBusTypes || []).slice(0,3);
  if(types.includes(b)) return b;

  const def = (APP.defaultBusTypes || []).slice(0,3);
  const iDef = def.indexOf(b);
  if(iDef>=0 && types[iDef]) return types[iDef];

  if(b.includes("ä¸Šç€‘")) return types[0] || b;
  if(b.includes("ç·å…ƒ")) return types[1] || b;
  if(b.includes("å¸‚éƒ¨") || b.includes("ç”°ä»£")) return types[2] || b;

  return b;
}

/* -------------------------
   Backend
------------------------- */
function createLocalBackend(){
  let rosterListeners=[], dailyListeners=[];
  return {
    type:"local",
    init: async()=>true,
    subscribeRoster:(cb)=>{ rosterListeners.push(cb); cb(DB.roster); return ()=> rosterListeners = rosterListeners.filter(x=>x!==cb); },
    saveRoster: async(roster)=>{ DB.roster = roster; saveDB(); rosterListeners.forEach(cb=>cb(DB.roster)); return true; },
    subscribeDaily:(dateK, cb)=>{ dailyListeners.push(cb); cb(ensureDaily(dateK)); return ()=> dailyListeners = dailyListeners.filter(x=>x!==cb); },
    updateStudent: async(dateK, studentId, patch)=>{ const r=setDailyStateLocal(dateK, studentId, patch); dailyListeners.forEach(cb=>cb(ensureDaily(dateK))); return r; },
    updateClassDone: async(dateK, className, done)=>{ setClassDoneLocal(dateK, className, done); dailyListeners.forEach(cb=>cb(ensureDaily(dateK))); return true; },
  };
}

function hasValidFirebaseConfig(cfg){
  return cfg && typeof cfg==="object" && String(cfg.projectId||"").trim() && !String(cfg.projectId).includes("YOUR_PROJECT");
}

function createCloudBackend(firebaseConfig, schoolId){
  let app=null, fs=null, auth=null;
  let unsubRoster=null, unsubDaily=null;

  function pathBase(){
    return fs.collection("school_bus").doc(String(schoolId||"default")).collection("data");
  }
  const rosterDocId="roster";

  function requireSignedIn(){
    if(!auth) auth = window.firebase.auth();
    if(!auth.currentUser) throw new Error("æœªãƒ­ã‚°ã‚¤ãƒ³");
    return true;
  }

  return {
    type:"cloud",
    init: async()=>{
      if(!window.firebase || !window.firebase.initializeApp) throw new Error("Firebase SDKãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“");
      if(!hasValidFirebaseConfig(firebaseConfig)) throw new Error("PRESET_FIREBASE_CONFIG ãŒæœªè¨­å®šã§ã™");
      app = window.firebase.apps?.length ? window.firebase.app() : window.firebase.initializeApp(firebaseConfig);
      fs = window.firebase.firestore();
      auth = window.firebase.auth();
      return true;
    },
    subscribeRoster:(cb)=>{
      requireSignedIn();
      if(unsubRoster) unsubRoster();
      unsubRoster = pathBase().doc(rosterDocId).onSnapshot((snap)=>{
        const data=snap.data();
        const roster=Array.isArray(data?.roster) ? data.roster : [];
        cb(roster);
      }, (err)=>{ console.warn(err); throw err; });
      return ()=>{ if(unsubRoster) unsubRoster(); unsubRoster=null; };
    },
    saveRoster: async(roster)=>{
      requireSignedIn();
      await pathBase().doc(rosterDocId).set({ roster, updatedAt: window.firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
      return true;
    },
    subscribeDaily:(dateK, cb)=>{
      requireSignedIn();
      if(unsubDaily) unsubDaily();
      const docId=`daily_${dateK}`;
      unsubDaily = pathBase().doc(docId).onSnapshot((snap)=>{
        const data=snap.data()||{};
        const states = data.states || {};
        for(const sid of Object.keys(states)){
          if(states[sid] && states[sid].status) states[sid].status = normalizeStatus(states[sid].status);
        }
        const daily={
          states,
          classDone: data.classDone || {},
          updatedAt: data.updatedAt ? (data.updatedAt.toMillis ? data.updatedAt.toMillis() : data.updatedAt) : 0,
          updatedBy: data.updatedBy || ""
        };
        cb(daily);
      }, (err)=>{ console.warn(err); throw err; });
      return ()=>{ if(unsubDaily) unsubDaily(); unsubDaily=null; };
    },
    updateStudent: async(dateK, studentId, patch)=>{
      requireSignedIn();
      const docId=`daily_${dateK}`;
      const ref=pathBase().doc(docId);

      const prevRaw = (State.dailyDoc?.states?.[studentId]) ? {...State.dailyDoc.states[studentId]} : { status:"none", note:"", ts:0, by:"", noClub:false };
      const prev = { ...prevRaw, status: normalizeStatus(prevRaw.status) };
      const next = { ...prev, ...patch, status: normalizeStatus(patch.status ?? prev.status), noClub: (patch.noClub ?? prev.noClub ?? false), ts: nowTs(), by:(DB.config.displayName || "â€”") };

      const payload = {
        states: { [String(studentId)]: next },
        updatedBy: (DB.config.displayName || "â€”"),
        updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
      };
      await ref.set(payload, { merge: true });

      return {prev,next};
    },
    updateClassDone: async(dateK, className, done)=>{
      requireSignedIn();
      const docId=`daily_${dateK}`;
      const ref=pathBase().doc(docId);
      const payload = {
        classDone: { [String(className)]: !!done },
        updatedBy: (DB.config.displayName || "â€”"),
        updatedAt: window.firebase.firestore.FieldValue.serverTimestamp()
      };
      await ref.set(payload, { merge: true });
      return true;
    }
  };
}

/* -------------------------
   UI
------------------------- */
function setAuthPill(){
  const auth = window.firebase?.auth?.();
  const user = auth?.currentUser;
  if(user){
    $("#auth-pill").className="px-3 py-2 rounded-2xl border text-xs font-black bg-emerald-50 border-emerald-100 text-emerald-700";
    $("#auth-pill").textContent=`ğŸ‘¤ ${user.email || "ãƒ­ã‚°ã‚¤ãƒ³ä¸­"}`;
  }else{
    $("#auth-pill").className="px-3 py-2 rounded-2xl border text-xs font-black bg-white border-slate-200 text-slate-500";
    $("#auth-pill").textContent="ğŸ‘¤ æœªãƒ­ã‚°ã‚¤ãƒ³";
  }
}
function setCloudPill(){
  if(State.cloudReady){
    $("#cloud-pill").className="px-3 py-2 rounded-2xl border text-xs font-black bg-blue-50 border-blue-100 text-blue-700";
    $("#cloud-pill").textContent="â˜ æ¥ç¶šä¸­";
  }else{
    $("#cloud-pill").className="px-3 py-2 rounded-2xl border text-xs font-black bg-white border-slate-200 text-slate-500";
    $("#cloud-pill").textContent="â˜ æœªæ¥ç¶š";
  }
}
function showLogin(show){
  $("#login-overlay").classList.toggle("hidden", !show);
  $("#login-error").classList.add("hidden");
  $("#login-error").textContent="";
}
function showCloudError(msg){
  $("#cloud-error-msg").textContent = msg || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼";
  $("#cloud-error-overlay").classList.remove("hidden");
}
function hideCloudError(){
  $("#cloud-error-overlay").classList.add("hidden");
}

/* -------------------------
   UI + Actionsï¼ˆå…ƒã‚³ãƒ¼ãƒ‰ã»ã¼ç¶­æŒï¼‰
------------------------- */
const UI = {
  switchTab(tab){
    State.tab=tab;
    ["check","monitor","print","settings"].forEach(t=>{
      $(`#section-${t}`).classList.toggle("hidden", t!==tab);
      $(`#tab-${t}`).classList.toggle("tab-active", t===tab);
      $(`#tab-${t}`).classList.toggle("text-slate-500", t!==tab);
    });
    $("#section-overview").classList.toggle("hidden", tab==="monitor");

    const main = $("#main-shell");
    if(main){
      if(tab==="monitor"){
        main.className = "print-shell w-screen max-w-none mx-0 px-2 py-3 space-y-3";
      }else{
        main.className = "print-shell max-w-[1400px] mx-auto px-4 py-6 space-y-6";
      }
    }

    if(tab==="check") renderCheck();
    if(tab==="monitor"){ renderMonitor(); layoutMonitor(); fitMonitor(); }
    if(tab==="print") renderPrint();
    if(tab==="settings") renderSettings();
  }
};

const Actions = {
  async quickToggle(studentId){
    const st = getDailyState(State.date, studentId);
    const nextStatus = (st.status === "ride") ? "none" : "ride";
    return await Actions.setStatus(studentId, nextStatus, st.note || "");
  },

  async toggleNoClub(studentId){
    const st = getDailyState(State.date, studentId);
    const next = !st.noClub;
    return await Actions.setNoClub(studentId, next);
  },

  async setNoClub(studentId, noClub){
    if(!State.backend){ showToast("æœªãƒ­ã‚°ã‚¤ãƒ³ / æœªæ¥ç¶šã§ã™"); return; }
    const s = State.roster.find(x=>String(x.id)===String(studentId));
    if(!s) return;

    if(State.classLock){
      showToast("ã“ã®å­¦ç´šã¯ç¢ºèªå®Œäº†ã§ãƒ­ãƒƒã‚¯ä¸­ã§ã™ï¼ˆãƒ­ãƒƒã‚¯è§£é™¤ã—ã¦ç·¨é›†ï¼‰");
      return;
    }

    try{
      // ä¹—è»Šã§ãªã„å ´åˆã¯ãƒˆã‚°ãƒ«ä¸å¯ï¼ˆUIå´ã§ã‚‚ç„¡åŠ¹åŒ–ï¼‰
      const cur = getDailyState(State.date, studentId);
      if(cur.status !== "ride"){
        showToast("å…ˆã«ã€Œä¹—è»Šã€ã‚’æŠ¼ã—ã¦ãã ã•ã„");
        return;
      }
      await State.backend.updateStudent(State.date, studentId, { noClub: !!noClub });
      await State.backend.updateClassDone(State.date, s.class, false);
      showToast(`${s.class} ${s.num} ${s.name}ï¼š${noClub ? "éƒ¨æ´»ã›ãšä¹—è»Š" : "éƒ¨æ´»ã‚ã‚Š"}`);
      return true;
    }catch(e){
      console.warn(e);
      showToast("ã‚¯ãƒ©ã‚¦ãƒ‰æ›´æ–°ã«å¤±æ•—ï¼ˆæ¨©é™/é€šä¿¡/ãƒ«ãƒ¼ãƒ«ç¢ºèªï¼‰");
    }
  },

  async setStatus(studentId, statusKey, note){
    if(!State.backend){ showToast("æœªãƒ­ã‚°ã‚¤ãƒ³ / æœªæ¥ç¶šã§ã™"); return; }
    const s = State.roster.find(x=>String(x.id)===String(studentId));
    if(!s) return;

    if(State.classLock){
      showToast("ã“ã®å­¦ç´šã¯ç¢ºèªå®Œäº†ã§ãƒ­ãƒƒã‚¯ä¸­ã§ã™ï¼ˆãƒ­ãƒƒã‚¯è§£é™¤ã—ã¦ç·¨é›†ï¼‰");
      return;
    }

    try{
      const cur = getDailyState(State.date, studentId);
      const nextStatus = normalizeStatus(statusKey);
      const patch = { status: nextStatus, note: note || "" , noClub: (nextStatus==="ride") ? !!cur.noClub : false };
      await State.backend.updateStudent(State.date, studentId, patch);
      await State.backend.updateClassDone(State.date, s.class, false);

      const label = APP.statuses.find(x=>x.key===normalizeStatus(statusKey))?.label || statusKey;
      showToast(`${s.class} ${s.num} ${s.name}ï¼š${label}`);
      return true;
    }catch(e){
      console.warn(e);
      showToast("ã‚¯ãƒ©ã‚¦ãƒ‰æ›´æ–°ã«å¤±æ•—ï¼ˆæ¨©é™/é€šä¿¡/ãƒ«ãƒ¼ãƒ«ç¢ºèªï¼‰");
    }
  },

  async setClassDone(done){
    if(!State.backend){ showToast("æœªãƒ­ã‚°ã‚¤ãƒ³ / æœªæ¥ç¶šã§ã™"); return; }
    const cls = $("#class-filter").value;
    if(!cls) return;
    await State.backend.updateClassDone(State.date, cls, !!done);
    State.classLock = !!done;
    renderCheck(); renderOverview();
    showToast(done ? `${cls} ç¢ºèªå®Œäº†` : `${cls} ç¢ºèªã‚’è§£é™¤`);
  },

  async unlockClass(){
    const cls = $("#class-filter")?.value || "";
    if(!cls){ showToast("å­¦ç´šãŒæœªé¸æŠã§ã™"); return; }

    try{
      if(State.backend){
        await State.backend.updateClassDone(State.date, cls, false);
      }else{
        // ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã®é‹ç”¨æ™‚
        setClassDoneLocal(State.date, cls, false);
      }
      State.classLock = false;
      renderCheck(); renderOverview();
      showToast("ãƒ­ãƒƒã‚¯è§£é™¤ã—ã¾ã—ãŸ");
    }catch(e){
      console.warn(e);
      showToast("ãƒ­ãƒƒã‚¯è§£é™¤ã«å¤±æ•—ï¼ˆé€šä¿¡/æ¨©é™/ãƒ«ãƒ¼ãƒ«ç¢ºèªï¼‰");
    }
  },

  async markAll(statusKey){
    if(!State.backend){ showToast("æœªãƒ­ã‚°ã‚¤ãƒ³ / æœªæ¥ç¶šã§ã™"); return; }
    const cls = $("#class-filter").value;
    const list = State.roster.filter(s=>s.class===cls).sort((a,b)=>a.num-b.num);
    if(!list.length) return;

    if(State.classLock){ showToast("ãƒ­ãƒƒã‚¯ä¸­ã§ã™ï¼ˆãƒ­ãƒƒã‚¯è§£é™¤ã—ã¦ç·¨é›†ï¼‰"); return; }

    const label = APP.statuses.find(x=>x.key===normalizeStatus(statusKey))?.label || statusKey;
    if(!confirm(`${cls} ã‚’ä¸€æ‹¬ã§ã€Œ${label}ã€ã«ã—ã¾ã™ã‹ï¼Ÿ`)) return;

    for(const s of list){
      await Actions.setStatus(s.id, statusKey, getDailyState(State.date, s.id).note || "");
      if(State.backend.type==="cloud") await new Promise(r=>setTimeout(r, 18));
    }
    showToast("ä¸€æ‹¬åæ˜ ã—ã¾ã—ãŸ");
    renderCheck();
  }
};

/* -------------------------
   Renderingï¼ˆå…ƒã‚³ãƒ¼ãƒ‰ç¶­æŒï¼‰
------------------------- */
function renderOverview(){
  const { classes, classDone, rideCount, busCounts, doneCount } = derived();

  $("#today-label").textContent = jpDateLabel(State.date);
  $("#school-ride-count").textContent = `${rideCount}å`;
  $("#school-ride-sub").textContent = `å­¦ç´šç¢ºèªï¼š${doneCount}/${classes.length} å­¦ç´š`;

  $("#bus-summary-chips").innerHTML = APP.busTypes.map(b=>{
    const cnt = busCounts[b] || 0;
    return `
      <span class="chip ${cnt? "":"opacity-50"} chip-ride">
        <span class="px-2 py-0.5 rounded-lg text-[10px] font-black ${busClass(b)}">${busShort(b)}</span>
        <span>${b}ï¼š${cnt}å</span>
      </span>
    `;
  }).join("");

  $("#class-progress-badges").innerHTML = classes.map(c=>{
    const done = classDone[c]===true;
    return `
      <div class="px-3 py-2 rounded-2xl border text-[11px] font-black ${done ? "bg-emerald-500 border-emerald-400 text-white shadow-lg shadow-emerald-100" : "bg-slate-100 border-slate-200 text-slate-500"}">
        ${c} ${done ? "âœ“" : ""}
      </div>
    `;
  }).join("");

  setCloudPill();
  setAuthPill();
}

/* ã“ã“ã‹ã‚‰å…ˆï¼ˆrenderCheckã€œï¼‰ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼è²¼ä»˜ã®ã¾ã¾ */
function renderCheck(){
  const { roster, classes, classDone } = derived();
  const filter=$("#class-filter");
  const current = filter.value || State.activeClass || classes[0] || "";
  State.activeClass=current;
  filter.innerHTML = classes.map(c=>`<option value="${c}" ${c===current?'selected':''}>${c}</option>`).join("");

  const selected = filter.value || current;
  const isDone = classDone[selected]===true;
  State.classLock = isDone;
  $("#btn-class-unlock").classList.toggle("hidden", !isDone);

  $("#btn-class-done").className = isDone
    ? "tap px-5 py-2 rounded-2xl text-sm font-black bg-emerald-500 text-white shadow-lg shadow-emerald-100 hover:bg-emerald-600"
    : "tap px-5 py-2 rounded-2xl text-sm font-black border-2 border-blue-600 text-blue-700 hover:bg-blue-50";
  $("#btn-class-done").textContent = isDone ? "âœ“ ç¢ºèªå®Œäº†ï¼ˆãƒ­ãƒƒã‚¯ä¸­ï¼‰" : "å­¦ç´šç¢ºèªã‚’å®Œäº†";

  const classKids = roster.filter(s=>s.class===selected).sort((a,b)=>a.num-b.num);
  $("#class-bus-summary").innerHTML = APP.busTypes.map(b=>{
    const cnt = classKids.filter(s => s.bus===b && getDailyState(State.date, s.id).status==="ride").length;
    if(cnt<=0) return "";
    return `<span class="px-2 py-1 rounded-xl text-[11px] font-black ${busClass(b)}">${busShort(b)} ${cnt}</span>`;
  }).join("");

  const q = ($("#student-search").value || "").trim().toLowerCase();
  const grid=$("#check-grid");
  grid.innerHTML="";

  const list = classKids.filter(s=>{
    if(!q) return true;
    return (`${s.name} ${s.stop} ${s.bus}`).toLowerCase().includes(q);
  });

  list.forEach(s=>{
    const st = getDailyState(State.date, s.id);
    const info = APP.statuses.find(x=>x.key===st.status) || APP.statuses[0];
    const locked = State.classLock;

    let cardClass = "bg-white border-slate-200";
    let nameClass = "text-slate-900";
    let subClass  = "text-slate-600";
    let topBtnClass = "bg-white/80 border-slate-200 text-slate-700 hover:bg-white";
    let noteChip = "text-amber-700 bg-amber-50 border-amber-100";

    if(st.status==="ride"){
      const t=rideThemeForBus(s.bus);
      cardClass=t.card; nameClass=t.name; subClass=t.sub; topBtnClass=t.menu; noteChip=t.note;
    }else if(st.status==="pickup"){
      cardClass = "bg-emerald-500 border-emerald-600 shadow-lg shadow-emerald-100";
      nameClass = "text-white"; subClass="text-emerald-50";
      topBtnClass = "bg-white/15 border-white/20 text-white hover:bg-white/20";
      noteChip = "text-white bg-white/15 border-white/20";
    }else if(st.status==="absent"){
      cardClass = "bg-slate-200 border-slate-300";
      nameClass = "text-slate-700"; subClass="text-slate-600";
      topBtnClass = "bg-white/60 border-white/60 text-slate-700 hover:bg-white";
      noteChip = "text-slate-700 bg-white/70 border-white/70";
    }else if(st.status==="other"){
      cardClass = "bg-amber-400 border-amber-500 shadow-lg shadow-amber-100";
      nameClass = "text-amber-950"; subClass="text-amber-900";
      topBtnClass = "bg-white/40 border-white/40 text-amber-950 hover:bg-white/50";
      noteChip = "text-amber-950 bg-white/35 border-white/40";
    }

    const card=document.createElement("div");
    card.className = `tap relative rounded-3xl border-2 p-3 h-[132px] flex flex-col justify-between cursor-pointer ${cardClass} ${locked ? "pointer-events-none opacity-60" : ""}`;
    card.onclick = ()=> Actions.quickToggle(s.id);

    const showNoClub = shouldShowNoClubToggle(s.class);
    const noClubOn = !!st.noClub;
    const noClubDisabled = (st.status !== "ride");
    const noClubBtnClass = noClubOn
      ? "bg-violet-600 border-violet-700 text-white hover:bg-violet-700 shadow-sm ring-2 ring-violet-300"
      : "bg-slate-50 border-slate-300 text-slate-700 hover:bg-slate-100";
    const noClubBtnHTML = showNoClub ? `
      <button class="tap pointer-events-auto px-2 py-1 rounded-xl border text-[10px] font-black ${noClubBtnClass} ${noClubDisabled ? "opacity-40 pointer-events-none" : ""}"
        title="éƒ¨æ´»ã›ãšä¹—è»Šï¼ˆå°åˆ·ã§ã‚°ãƒ¬ãƒ¼è¡¨ç¤ºï¼‰"
        onclick="event.stopPropagation(); Actions.toggleNoClub('${s.id}')">éƒ¨æ´»ã›ãš</button>
    ` : "";

    const noteText = st.note ? `ğŸ“ ${st.note}` : `ğŸ“`;
    const noteVisibility = st.note ? "" : "invisible";

    card.innerHTML = `
      <div class="flex items-center justify-between gap-2">
        <div class="text-[10px] font-black ${st.status==="ride"||st.status==="pickup"||st.status==="other" ? "opacity-80" : "text-slate-400"} ${st.status==="ride"||st.status==="pickup" ? "text-white" : ""}">NO.${s.num}</div>
        ${noClubBtnHTML}
      </div>

      <div class="min-w-0">
        <!-- â˜…å·®ã—æ›¿ãˆï¼šæ‹…ä»»ãƒã‚§ãƒƒã‚¯ã®å…ç«¥åã‚’å°‘ã—å¤§ãã -->
        <div class="font-black text-[19px] md:text-[20px] leading-tight truncate ${nameClass}">${s.name}</div>
      </div>

      <div class="flex items-center gap-2 min-w-0">
        <span class="chip ${info.chip}">${info.label}</span>
        <span class="text-[10px] font-black px-2 py-1 rounded-xl border truncate ${noteVisibility} ${noteChip}">${noteText}</span>
      </div>

      <div class="flex items-center gap-2 min-w-0">
        <span class="px-2 py-0.5 rounded-lg text-[10px] font-black ${busClass(s.bus)}">${busShort(s.bus)}</span>
        <div class="text-[11px] font-bold truncate ${subClass}">${s.stop}</div>
      </div>
    `;
    grid.appendChild(card);
  });

  if(list.length===0){
    grid.innerHTML = `
      <div class="col-span-full bg-white border border-slate-200 rounded-3xl p-8 text-center text-slate-500">
        <div class="text-lg font-black">è©²å½“ã™ã‚‹å…ç«¥ãŒã„ã¾ã›ã‚“</div>
        <div class="text-xs font-bold mt-1">æ¤œç´¢æ¡ä»¶ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>
      </div>
    `;
  }
}

function renderMonitor(){
  const { roster, classes, classDone, busCounts, rideCount, doneCount } = derived();

  $("#monitor-summary").innerHTML = `
    <span class="px-2 py-1 rounded-xl bg-slate-900 text-white text-[11px] font-black">å…¨æ ¡ãƒ¢ãƒ‹ã‚¿ï¼ˆä¸‹æ ¡ï¼‰</span>
    <span class="text-sm font-black text-slate-900">${jpDateLabel(State.date)}</span>
    <span class="text-xs font-black text-slate-500">ç¢ºèª ${doneCount}/${classes.length}</span>
    <span class="text-sm font-black text-slate-900">ä¹—è»Š ${rideCount}å</span>
    ${APP.busTypes.map(b=>`
      <span class="px-2 py-1 rounded-xl text-[11px] font-black ${busClass(b)}">${busShort(b)} ${busCounts[b]||0}</span>
    `).join("")}
  `;

  const filter = State.monitorFilter;
  const grid = $("#monitor-grid");
  grid.innerHTML="";

  const rootEl = $("#monitor-fit-root");
  const rootW = rootEl ? rootEl.clientWidth : 1200;

  const showClasses = classes.filter(cls=>{
    const done = classDone[cls]===true;
    if(filter==="pending" && done) return false;
    if(filter==="done" && !done) return false;
    return true;
  });

  const n = Math.max(1, showClasses.length);
  const gapPx = 8;
  const computed = Math.floor((rootW - gapPx*(n-1)) / n);
  const cardW = Math.min(360, Math.max(190, computed));

  showClasses.forEach(cls=>{
    const done = classDone[cls]===true;

    const kids = roster.filter(s=>s.class===cls).sort((a,b)=>a.num-b.num);
    const riders = kids.filter(s=>getDailyState(State.date, s.id).status==="ride");

    const breakdown = APP.busTypes.map(b=>{
      const cnt = riders.filter(s=>s.bus===b).length;
      return cnt>0 ? `<span class="px-1.5 py-0.5 rounded-lg text-[10px] font-black ${busClass(b)}">${busShort(b)}${cnt}</span>` : "";
    }).join("");

    const card = document.createElement("div");
    card.className = `shrink-0 bg-white border border-slate-200 rounded-3xl p-2 shadow-sm`;
    card.style.width = cardW + "px";

    card.innerHTML = `
      <div class="flex items-center justify-between gap-2 border-b border-slate-100 pb-1">
        <div class="flex items-center gap-2">
          <div class="text-xl font-black italic tracking-tight">${cls}</div>
          <span class="px-2 py-0.5 rounded-xl bg-slate-100 border border-slate-200 text-[11px] font-black">${riders.length}å</span>
        </div>
        <div class="text-[11px] font-black ${done ? "text-emerald-700" : "text-amber-700"}">
          ${done ? "â— å®Œäº†" : "â—‹ æœªå®Œ"}
        </div>
      </div>

      <div class="mt-1 flex flex-wrap gap-1">${breakdown || `<span class="text-[11px] font-bold text-slate-400">å†…è¨³ãªã—</span>`}</div>

      <div class="mt-2 grid gap-1">
        ${kids.map(s=>{
          const st = getDailyState(State.date, s.id);
          const info = APP.statuses.find(x=>x.key===st.status) || APP.statuses[0];

          let rowBg = "bg-white border-slate-100";
          if(st.status==="ride") rowBg = rideRowThemeForBus(s.bus);
          else if(st.status==="pickup") rowBg="bg-emerald-50 border-emerald-100";
          else if(st.status==="absent") rowBg="bg-slate-100 border-slate-200";
          else if(st.status==="other") rowBg="bg-amber-50 border-amber-100";

          const showStatusMini = (st.status!=="none" && st.status!=="ride");
          const statusMini = showStatusMini ? `<span class="px-1.5 py-0.5 rounded-lg text-[10px] font-black ${info.chip}">${info.short}</span>` : "";

          return `
            <div class="grid grid-cols-[28px_1fr_34px] items-center gap-1 px-1.5 py-1 rounded-2xl border ${rowBg}">
              <div class="w-[28px] h-6 rounded-xl bg-slate-900 text-white grid place-items-center font-black text-[11px] leading-none">${s.num}</div>

              <div class="min-w-0 flex items-center gap-1.5">
                <div class="min-w-0 font-black truncate" style="font-size:14px; line-height:1.15;">${s.name}</div>
                ${statusMini}
              </div>

              <div class="w-[34px] flex justify-end">
                <span class="w-[34px] inline-flex justify-center px-0 py-0.5 rounded-lg text-[10px] font-black leading-none ${busClass(s.bus)}">${busShort(s.bus)}</span>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;
    grid.appendChild(card);
  });

  if(!grid.children.length){
    grid.innerHTML = `
      <div class="bg-white border border-slate-200 rounded-3xl p-10 text-center text-slate-500">
        <div class="text-xl font-black">è¡¨ç¤ºå¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“</div>
        <div class="text-xs font-bold mt-1">ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>
      </div>
    `;
  }
}

function renderPrint(){
  const { roster, classes } = derived();
  const mode = State.printMode;
  const title = `ã‚¹ã‚¯ãƒ¼ãƒ«ãƒã‚¹ä¹—è»Šåç°¿ï¼ˆ${jpDateLabel(State.date)} / ä¸‹æ ¡ï¼‰`;

  const container=$("#print-content");
  container.innerHTML="";

  const makeHeaderHTML = ()=>`
    <div class="print-title flex flex-wrap items-end justify-between gap-2 border-b-4 border-black pb-2 mb-3">
      <div class="print-title-en text-xl sm:text-2xl font-black tracking-tight italic">ä¹—è»Šç¢ºèªãƒã‚§ãƒƒã‚¯</div>
      <div class="print-title-ja text-xs sm:text-base font-black">${title}</div>
    </div>
  `;

  if(mode==="bus"){
    const page=document.createElement("div");
    page.className="print-page print-card bus-sheet rounded-3xl border border-slate-200 shadow-sm p-3";
    page.innerHTML = makeHeaderHTML();

    const sheet=document.createElement("div");
    sheet.className="print-bus-sheet";

    APP.busTypes.forEach(busName=>{
      const rows = roster
        .filter(s=>getDailyState(State.date, s.id).status==="ride" && s.bus===busName)
        .sort((a,b)=> a.class.localeCompare(b.class, undefined, {numeric:true}) || (a.num-b.num));

      const card=document.createElement("div");
      card.className="print-bus-card";

      const half = Math.ceil(rows.length/2);
      const left = rows.slice(0, half);
      const right = rows.slice(half);
      const maxN = Math.max(left.length, right.length);

      /* â˜…ä¿®æ­£ï¼šãƒã‚¹åœã‚’æ°åã®å³ã«è¿½åŠ ï¼ˆ2åˆ—ç¶­æŒï¼‰ */
      card.innerHTML = `
        <div class="print-bus-title">â–  ${busName}ï¼ˆ${rows.length}åï¼‰</div>
        <table>
          <colgroup>
            <!-- å·¦ï¼ˆåˆè¨ˆ50%ï¼‰ -->
            <col style="width:10%;">
            <col style="width:5%;">
            <col style="width:16.5%;">
            <col style="width:16.5%;">
            <col style="width:2%;">
            <!-- å³ï¼ˆåˆè¨ˆ50%ï¼‰ -->
            <col style="width:10%;">
            <col style="width:5%;">
            <col style="width:16.5%;">
            <col style="width:16.5%;">
            <col style="width:2%;">
          </colgroup>
          <thead>
            <tr>
              <th>ã‚¯ãƒ©ã‚¹</th><th>ç•ª</th><th>æ°å</th><th>ãƒã‚¹åœ</th><th>â–¡</th>
              <th>ã‚¯ãƒ©ã‚¹</th><th>ç•ª</th><th>æ°å</th><th>ãƒã‚¹åœ</th><th>â–¡</th>
            </tr>
          </thead>
          <tbody>
            ${
              maxN
              ? Array.from({length:maxN}).map((_,i)=>{
                  const a = left[i] || null;
                  const b = right[i] || null;

                  const aCls = a ? formatClassLabel(a.class) : "";
                  const bCls = b ? formatClassLabel(b.class) : "";

                  const basePt = 6.2; /* â˜…å°‘ã—è©°ã‚ã‚‹ */
                  const aClsPt = a ? fitFontPt(aCls, basePt, 6, 5.6) : null;
                  const bClsPt = b ? fitFontPt(bCls, basePt, 6, 5.6) : null;

                  const aNoClub = a ? !!getDailyState(State.date, a.id).noClub : false;
                  const bNoClub = b ? !!getDailyState(State.date, b.id).noClub : false;

                  const aNameStr = a ? (a.name + (aNoClub ? "ï¼ˆéƒ¨æ´»ã›ãšï¼‰" : "")) : "";
                  const bNameStr = b ? (b.name + (bNoClub ? "ï¼ˆéƒ¨æ´»ã›ãšï¼‰" : "")) : "";

                  const aNamePt = a ? fitFontPt(aNameStr, basePt, 9, 5.4) : null;
                  const bNamePt = b ? fitFontPt(bNameStr, basePt, 9, 5.4) : null;

                  const aStopPt = a ? fitFontPt(a.stop, basePt, 10, 5.4) : null;
                  const bStopPt = b ? fitFontPt(b.stop, basePt, 10, 5.4) : null;
                  const aBg = aNoClub ? "background:#e5e7eb !important;" : "";
                  const bBg = bNoClub ? "background:#e5e7eb !important;" : "";

                  const aClsStyle = aClsPt ? `font-size:${aClsPt}pt !important;` : "";
                  const bClsStyle = bClsPt ? `font-size:${bClsPt}pt !important;` : "";
                  const aNameStyle = aNamePt ? `font-size:${aNamePt}pt !important;` : "";
                  const bNameStyle = bNamePt ? `font-size:${bNamePt}pt !important;` : "";
                  const aStopStyle = aStopPt ? `font-size:${aStopPt}pt !important;` : "";
                  const bStopStyle = bStopPt ? `font-size:${bStopPt}pt !important;` : "";

                  return `
                    <tr>
                      <td class="td-class" style="${aClsStyle}${aBg}">${a ? esc(aCls) : ""}</td>
                      <td style="text-align:center; font-weight:800; white-space:nowrap; ${aBg}">${a ? a.num : ""}</td>
                      <td class="td-name" style="${aNameStyle}${aBg}">${a ? esc(a.name + (aNoClub ? "ï¼ˆéƒ¨æ´»ã›ãšï¼‰" : "")) : ""}</td>
                      <td class="td-stop-bus" style="${aStopStyle}${aBg}">${a ? esc(a.stop) : ""}</td>
                      <td style="text-align:center; ${aBg}">${a ? "â–¡" : ""}</td>

                      <td class="td-class" style="${bClsStyle}${bBg}">${b ? esc(bCls) : ""}</td>
                      <td style="text-align:center; font-weight:800; white-space:nowrap; ${bBg}">${b ? b.num : ""}</td>
                      <td class="td-name" style="${bNameStyle}${bBg}">${b ? esc(b.name + (bNoClub ? "ï¼ˆéƒ¨æ´»ã›ãšï¼‰" : "")) : ""}</td>
                      <td class="td-stop-bus" style="${bStopStyle}${bBg}">${b ? esc(b.stop) : ""}</td>
                      <td style="text-align:center; ${bBg}">${b ? "â–¡" : ""}</td>
                    </tr>
                  `;
                }).join("")
              : `<tr><td colspan="10" style="text-align:center; padding:3mm; font-weight:900; color:#64748b;">ä¹—è»Šäºˆå®šãªã—</td></tr>`
            }
          </tbody>
        </table>
      `;

      sheet.appendChild(card);
    });

    page.appendChild(sheet);
    container.appendChild(page);
    return;
  }

  let first = true;
  classes.forEach(cls=>{
    const kids = roster.filter(s=>s.class===cls).sort((a,b)=>a.num-b.num);
    const page=document.createElement("div");
    page.className="print-page print-class-card rounded-3xl border border-slate-200 shadow-sm p-4 mb-6";

    const compactClass = kids.length > 26 ? "compact" : "";

    const headerHTML = first ? makeHeaderHTML() : "";
    first = false;

    page.innerHTML = `
      ${headerHTML}
      <div class="print-class-title">â–  ${formatClassLabel(cls)}ï¼ˆ${kids.length}åï¼‰</div>
      <table class="${compactClass}">
        <colgroup>
          <col style="width:10%;">
          <col style="width:28%;">
          <col style="width:14%;">
          <col style="width:12%;">
          <col style="width:28%;">
          <col style="width:8%;">
        </colgroup>
        <thead>
          <tr>
            <th>ç•ªå·</th><th>æ°å</th><th>çŠ¶æ…‹</th><th>ãƒã‚¹</th><th>ãƒã‚¹åœ</th><th>â–¡</th>
          </tr>
        </thead>
        <tbody>
          ${
            kids.map(s=>{
              const st=getDailyState(State.date, s.id);
              const info=APP.statuses.find(x=>x.key===st.status) || APP.statuses[0];
              const nameStr = s.name + (st.noClub ? "ï¼ˆéƒ¨æ´»ã›ãšï¼‰" : "");
              const namePt = fitFontPt(nameStr, 9.0, 9, 7.2);
              const nameStyle = namePt ? `font-size:${namePt}pt !important;` : "";
              return `
                <tr style="${st.noClub ? 'background:#e5e7eb !important;' : ''}">
                  <td style="text-align:center; font-weight:900; white-space:nowrap;">${s.num}</td>
                  <td class="td-name" style="${nameStyle}">${esc(s.name + (st.noClub ? "ï¼ˆéƒ¨æ´»ã›ãšï¼‰" : ""))}</td>
                  <td style="text-align:center; font-weight:900; white-space:nowrap;">${esc(info.label)}</td>
                  <td style="text-align:center; font-weight:900; white-space:nowrap;">${esc(busShort(s.bus))}</td>
                  <td class="td-stop">${esc(s.stop)}</td>
                  <td style="text-align:center;">â–¡</td>
                </tr>
              `;
            }).join("")
          }
        </tbody>
      </table>
    `;
    container.appendChild(page);
  });
}

function layoutMonitor(){
  const root=$("#monitor-fit-root");
  if(!root) return;
  const header=document.querySelector("header");
  const headerH=header ? header.offsetHeight : 0;
  const h = Math.max(360, window.innerHeight - headerH - 110);
  root.style.height = h + "px";
}
function fitMonitor(){
  if(State.tab!=="monitor") return;
  const root=$("#monitor-fit-root");
  const content=$("#monitor-fit");
  if(!root || !content) return;
  content.style.transform="scale(1)";
  content.style.transformOrigin="top left";
  const maxW = root.clientWidth;
  const maxH = root.clientHeight;
  const w = content.scrollWidth;
  const h = content.scrollHeight;
  if(w<=0 || h<=0) return;
  const scale = Math.min(maxW / w, maxH / h);
  const final = Math.min(scale, 1.9);
  content.style.transform = `scale(${final})`;
}

/* -------------------------
   CSVï¼ˆå…ƒã‚³ãƒ¼ãƒ‰ï¼‰
------------------------- */
function downloadBlob(content, filename, type="application/octet-stream"){
  const blob = new Blob([content], {type});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
function exportJSON(){
  downloadBlob(JSON.stringify(State.roster,null,2), `bus_roster_${dateKey()}.json`, "application/json");
}
function exportCSV(){
  const header=["id","class","num","name","bus","stop"];
  const lines=[header.join(",")].concat(
    State.roster.slice()
      .sort((a,b)=>a.class.localeCompare(b.class, undefined, {numeric:true}) || (a.num-b.num))
      .map(s=>{
        return header.map(k=>{
          const v=(s[k] ?? "");
          const q=String(v).replace(/"/g,'""');
          return `"${q}"`;
        }).join(",");
      })
  );
  const csv = "\ufeff" + lines.join("\n");
  downloadBlob(csv, `bus_roster_${dateKey()}.csv`, "text/csv;charset=utf-8");
}
function parseCSV(text){
  const rows=[]; let i=0, field="", row=[], inQuotes=false;
  while(i<text.length){
    const c=text[i];
    if(inQuotes){
      if(c==='"' && text[i+1]==='"'){ field+='"'; i+=2; continue; }
      if(c==='"'){ inQuotes=false; i++; continue; }
      field+=c; i++; continue;
    }else{
      if(c==='"'){ inQuotes=true; i++; continue; }
      if(c===','){ row.push(field); field=""; i++; continue; }
      if(c==='\n'){ row.push(field); rows.push(row); field=""; row=[]; i++; continue; }
      if(c==='\r'){ i++; continue; }
      field+=c; i++; continue;
    }
  }
  if(field.length || row.length){ row.push(field); rows.push(row); }
  return rows;
}
async function readCsvTextSmart(file){
  const buf = await file.arrayBuffer();
  const u8 = new Uint8Array(buf);
  const hasUtf8Bom = u8.length>=3 && u8[0]===0xEF && u8[1]===0xBB && u8[2]===0xBF;

  const tryDecode = (enc)=>{
    try{ return new TextDecoder(enc, {fatal:false}).decode(buf); }
    catch(e){ return null; }
  };

  let text = tryDecode("utf-8") ?? "";
  if(hasUtf8Bom) text = text.replace(/^\uFEFF/, "");

  if(text.includes(" ")){
    const sjis = tryDecode("shift-jis");
    if(sjis && !sjis.includes(" ")) text = sjis;
  }

  text = text.replace(/^\uFEFF/, "");
  return text;
}
async function importCSV(file){
  const text = await readCsvTextSmart(file);
  const rows=parseCSV(text);
  if(rows.length<2){ showToast("CSVãŒç©ºã§ã™"); return; }

  const header=rows[0].map(h=>String(h).trim());
  const idx=(name)=>header.indexOf(name);
  const required=["class","num","name","bus","stop"];
  if(required.some(r=>idx(r)===-1)){
    alert(`CSVãƒ˜ãƒƒãƒ€ã«å¿…è¦é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nå¿…è¦ï¼š${required.join(", ")}\nç¾åœ¨ï¼š${header.join(", ")}`);
    return;
  }

  const roster = rows.slice(1)
    .filter(r=>r.some(x=>String(x).trim()!==""))
    .map(r=>{
      const id = idx("id")>=0 ? Number(r[idx("id")]) : (Date.now()+Math.floor(Math.random()*10000));
      return {
        id: id || (Date.now()+Math.floor(Math.random()*10000)),
        class: String(r[idx("class")]||"").trim(),
        num: Number(r[idx("num")]) || 0,
        name: String(r[idx("name")]||"").trim(),
        bus: mapBusToCurrent(String(r[idx("bus")]||"").trim()),
        stop: String(r[idx("stop")]||"").trim()
      };
    })
    .filter(s=>s.class && s.num && s.name);

  if(!roster.length){ showToast("å–ã‚Šè¾¼ã¿å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
  if(!confirm(`CSVã‚’å–ã‚Šè¾¼ã¿ã¾ã™ã€‚\nä»¶æ•°ï¼š${roster.length}å\nï¼ˆç¾åœ¨ã®åç°¿ã‚’ç½®ãæ›ãˆã¾ã™ï¼‰`)) return;

  await State.backend.saveRoster(roster);
  showToast("CSVå–ã‚Šè¾¼ã¿å®Œäº†");
  renderAll();
}

/* -------------------------
   Settingsï¼ˆUIå¤‰æ›´ã«åˆã‚ã›ã¦æ›´æ–°ï¼‰
------------------------- */
const Settings = {
  startEdit(id){
    const s = State.roster.find(x=>String(x.id)===String(id));
    if(!s) return;
    $("#edit-id").value=s.id;
    $("#input-class").value=s.class;
    $("#input-num").value=s.num;
    $("#input-name").value=s.name;
    $("#input-bus").value=s.bus;
    $("#input-stop").value=s.stop;

    $("#editor-dot").className="w-2 h-8 bg-amber-500 rounded-full";
    $("#editor-title").textContent="å…ç«¥æƒ…å ±ã®ç·¨é›†";
    $("#btn-save").textContent="ä¿å­˜";
    $("#btn-save").className="tap w-full px-5 py-3 rounded-2xl bg-amber-500 text-white font-black shadow-lg shadow-amber-100 hover:bg-amber-600";
    $("#btn-cancel-edit").classList.remove("hidden");
    window.scrollTo({ top:0, behavior:"smooth" });
  },
  cancelEdit(){
    $("#student-form").reset();
    $("#edit-id").value="";
    $("#editor-dot").className="w-2 h-8 bg-blue-600 rounded-full";
    $("#editor-title").textContent="å…ç«¥ã®è¿½åŠ ";
    $("#btn-save").textContent="è¿½åŠ ";
    $("#btn-save").className="tap w-full px-5 py-3 rounded-2xl bg-blue-600 text-white font-black shadow-lg shadow-blue-100 hover:bg-blue-700";
    $("#btn-cancel-edit").classList.add("hidden");
  },
  async deleteStudent(id){
    const s = State.roster.find(x=>String(x.id)===String(id));
    if(!s) return;
    if(!confirm(`å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n${s.class} ${s.num} ${s.name}`)) return;
    const next = State.roster.filter(x=>String(x.id)!==String(id));
    await State.backend.saveRoster(next);
    showToast("å‰Šé™¤ã—ã¾ã—ãŸ");
    renderAll();
  }
};

function renderSettings(){
  $("#cfg-display-name").value = DB.config.displayName || "";
  const bt = sanitizeBusTypes(DB.config.busTypes, APP.defaultBusTypes);
  APP.busTypes = bt.slice();
  DB.config.busTypes = bt.slice();
  if($("#cfg-bus-0")) $("#cfg-bus-0").value = bt[0] || "";
  if($("#cfg-bus-1")) $("#cfg-bus-1").value = bt[1] || "";
  if($("#cfg-bus-2")) $("#cfg-bus-2").value = bt[2] || "";
  refreshBusSelectOptions();
  // ã€Œéƒ¨æ´»ã›ãšä¹—è»Šã€è¡¨ç¤ºå­¦å¹´
  const gset = new Set((DB.config.noClubGrades || []).map(String));
  for(let g=1; g<=6; g++){
    const el = $(`#cfg-noclub-g${g}`);
    if(el) el.checked = gset.has(String(g));
  }
  $("#roster-count-label").textContent = `å…¨ ${State.roster.length} å`;

  const auth = window.firebase?.auth?.();
  const user = auth?.currentUser;

  $("#settings-auth").textContent = user ? `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.email || "user"}` : "æœªãƒ­ã‚°ã‚¤ãƒ³";
  $("#settings-auth").className = user
    ? "px-3 py-2 rounded-2xl border text-xs font-black bg-emerald-50 border-emerald-100 text-emerald-700"
    : "px-3 py-2 rounded-2xl border text-xs font-black bg-white border-slate-200 text-slate-500";

  $("#settings-cloud").textContent = State.cloudReady ? "ã‚¯ãƒ©ã‚¦ãƒ‰ï¼šæ¥ç¶šOK" : "ã‚¯ãƒ©ã‚¦ãƒ‰ï¼šæœªæ¥ç¶š";
  $("#settings-cloud").className = State.cloudReady
    ? "px-3 py-2 rounded-2xl border text-xs font-black bg-blue-50 border-blue-100 text-blue-700"
    : "px-3 py-2 rounded-2xl border text-xs font-black bg-white border-slate-200 text-slate-500";

  $("#settings-schoolid").textContent = PRESET_SCHOOL_ID;
  $("#settings-projectid").textContent = String(PRESET_FIREBASE_CONFIG.projectId || "--");

  $("#settings-list-body").innerHTML = State.roster.slice()
    .sort((a,b)=>a.class.localeCompare(b.class, undefined, {numeric:true}) || (a.num-b.num))
    .map(s=>`
      <tr class="hover:bg-slate-50">
        <td class="p-3 font-black text-blue-700">${s.class}</td>
        <td class="p-3 font-black text-slate-500">${s.num}</td>
        <td class="p-3 font-black">${esc(s.name)}</td>
        <td class="p-3"><span class="px-2 py-1 rounded-xl text-[11px] font-black ${busClass(s.bus)}">${esc(s.bus)}</span></td>
        <td class="p-3 text-xs font-bold text-slate-500">${esc(s.stop)}</td>
        <td class="p-3 text-center whitespace-nowrap">
          <button class="tap px-3 py-2 rounded-2xl bg-blue-50 border border-blue-100 text-blue-700 text-xs font-black hover:bg-blue-100" onclick="Settings.startEdit('${s.id}')">ç·¨é›†</button>
          <button class="tap px-3 py-2 rounded-2xl bg-rose-50 border border-rose-100 text-rose-700 text-xs font-black hover:bg-rose-100" onclick="Settings.deleteStudent('${s.id}')">å‰Šé™¤</button>
        </td>
      </tr>
    `).join("");
}

/* -------------------------
   Subscriptions / Cloud apply
------------------------- */
let unsubRoster=null, unsubDaily=null;

async function applyBackend(){
  if(unsubRoster){ unsubRoster(); unsubRoster=null; }
  if(unsubDaily){ unsubDaily(); unsubDaily=null; }
  State.cloudReady=false;

  const auth = window.firebase.auth();
  if(!auth.currentUser){
    State.backend=null;
    State.cloudReady=false;
    setCloudPill();
    return;
  }

  try{
    const backend = createCloudBackend(PRESET_FIREBASE_CONFIG, PRESET_SCHOOL_ID);
    await backend.init();
    State.backend=backend;

    setupSubscriptions(); // ã“ã“ã§ onSnapshot é–‹å§‹
    State.cloudReady=true;
    setCloudPill();
    renderAll();
  }catch(e){
    console.warn(e);
    State.backend=null;
    State.cloudReady=false;
    setCloudPill();
    showCloudError(String(e?.message || e));
  }
}

function setupSubscriptions(){
  unsubRoster = State.backend.subscribeRoster((roster)=>{
    State.roster = Array.isArray(roster) ? roster : [];
    DB.roster = State.roster; saveDB();
    syncBusTypesFromRoster(State.roster);
    const classes=[...new Set(State.roster.map(s=>s.class))].sort(sortClassKey);
    if(!classes.includes(State.activeClass)) State.activeClass = classes[0] || "";
    renderAll();
  });

  unsubDaily = State.backend.subscribeDaily(State.date, (daily)=>{
    if(daily && daily.states){
      for(const sid of Object.keys(daily.states)){
        daily.states[sid].status = normalizeStatus(daily.states[sid].status);
      }
    }
    State.dailyDoc=daily;
    DB.daily[State.date]=daily; saveDB();
    renderAll();
    if(State.tab==="monitor"){ layoutMonitor(); fitMonitor(); }
  });
}
function resubscribeDaily(){
  if(!State.backend) return;
  if(unsubDaily){ unsubDaily(); unsubDaily=null; }
  unsubDaily = State.backend.subscribeDaily(State.date, (daily)=>{
    if(daily && daily.states){
      for(const sid of Object.keys(daily.states)){
        daily.states[sid].status = normalizeStatus(daily.states[sid].status);
      }
    }
    State.dailyDoc=daily;
    DB.daily[State.date]=daily; saveDB();
    renderAll();
    if(State.tab==="monitor"){ layoutMonitor(); fitMonitor(); }
  });
}

/* -------------------------
   Bindings + Boot
------------------------- */
function renderAll(){
  renderOverview();
  if(State.tab==="check") renderCheck();
  if(State.tab==="monitor"){ renderMonitor(); layoutMonitor(); fitMonitor(); }
  if(State.tab==="print") renderPrint();
  if(State.tab==="settings") renderSettings();
}

function bind(){
  $("#date-picker").value = State.date;
  $("#date-picker").addEventListener("change",(e)=>{
    State.date = e.target.value || dateKey();
    resubscribeDaily();
  });
  $("#btn-prev-day").onclick=()=>{ State.date=addDays(State.date,-1); $("#date-picker").value=State.date; resubscribeDaily(); };
  $("#btn-next-day").onclick=()=>{ State.date=addDays(State.date, 1); $("#date-picker").value=State.date; resubscribeDaily(); };

  $("#class-filter").addEventListener("change",()=>{ State.activeClass=$("#class-filter").value; renderCheck(); });
  $("#student-search").addEventListener("input",()=>renderCheck());

  $("#btn-class-done").onclick=()=>{
    if(State.classLock){
      showToast("ãƒ­ãƒƒã‚¯ä¸­ã§ã™ï¼ˆè§£é™¤ã¯ã€Œãƒ­ãƒƒã‚¯è§£é™¤ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰");
      return;
    }
    Actions.setClassDone(true);
  };
  $("#btn-class-unlock").onclick=()=>Actions.unlockClass();
  $("#btn-mark-all-ride").onclick=()=>Actions.markAll("ride");
  $("#btn-mark-all-clear").onclick=()=>Actions.markAll("none");

  $("#monitor-filter").addEventListener("change",(e)=>{ State.monitorFilter=e.target.value; renderMonitor(); layoutMonitor(); fitMonitor(); });
  $("#btn-monitor-refresh").onclick=()=>{ renderMonitor(); layoutMonitor(); fitMonitor(); showToast("æ›´æ–°ã—ã¾ã—ãŸ"); };

  $("#print-mode").addEventListener("change",(e)=>{ State.printMode=e.target.value; renderPrint(); });

  $("#btn-fullscreen").onclick=async()=>{
    try{
      if(!document.fullscreenElement){
        await document.documentElement.requestFullscreen();
        showToast("å…¨ç”»é¢ã«ã—ã¾ã—ãŸ");
      }else{
        await document.exitFullscreen();
        showToast("å…¨ç”»é¢ã‚’è§£é™¤ã—ã¾ã—ãŸ");
      }
      if(State.tab==="monitor"){ layoutMonitor(); fitMonitor(); }
    }catch(e){
      showToast("å…¨ç”»é¢ã«ã§ãã¾ã›ã‚“ã§ã—ãŸ");
    }
  };

  
  $("#btn-save-config").onclick=async()=>{
    const prevBusTypes = sanitizeBusTypes(DB.config.busTypes, APP.defaultBusTypes);
    const nextBusTypes = sanitizeBusTypes([
      $("#cfg-bus-0")?.value?.trim(),
      $("#cfg-bus-1")?.value?.trim(),
      $("#cfg-bus-2")?.value?.trim()
    ], prevBusTypes);

    DB.config.displayName=$("#cfg-display-name").value.trim();
    DB.config.busTypes = nextBusTypes.slice();
    // ã€Œéƒ¨æ´»ã›ãšä¹—è»Šã€è¡¨ç¤ºå­¦å¹´ï¼ˆæ‹…ä»»ãƒã‚§ãƒƒã‚¯ã®ã‚«ãƒ¼ãƒ‰ã«è¡¨ç¤ºã™ã‚‹å­¦å¹´ï¼‰
    const noClubGrades = [];
    for(let g=1; g<=6; g++){
      if($(`#cfg-noclub-g${g}`)?.checked) noClubGrades.push(String(g));
    }
    DB.config.noClubGrades = noClubGrades;
    APP.busTypes = nextBusTypes.slice();
    saveDB();

    // åç°¿ã®ã€Œåˆ©ç”¨ãƒã‚¹ã€è¡¨è¨˜ã‚‚ã€æ—§â†’æ–°ã§ç½®ãæ›ãˆã‚‹ï¼ˆä¿å­˜æ™‚ï¼‰
    let changed=false;
    const nextRoster = (State.roster || []).map(s=>{
      const bus = String(s?.bus || "");
      let nb = bus;
      for(let i=0;i<3;i++){
        if(bus === prevBusTypes[i]) nb = nextBusTypes[i];
        if(bus === (APP.defaultBusTypes?.[i] || "")) nb = nextBusTypes[i];
      }
      if(nb !== bus){ changed=true; return { ...s, bus: nb }; }
      return s;
    });

    if(changed){
      try{
        if(State.backend){
          await State.backend.saveRoster(nextRoster);
        }else{
          State.roster = nextRoster;
          DB.roster = nextRoster;
          saveDB();
        }
      }catch(e){
        console.warn(e);
        showToast("åç°¿ã®æ›´æ–°ã«å¤±æ•—ï¼ˆé€šä¿¡/æ¨©é™ï¼‰");
      }
    }

    showToast("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    renderAll();
  };

  $("#btn-reset-busnames").onclick=()=>{
    if($("#cfg-bus-0")) $("#cfg-bus-0").value = (APP.defaultBusTypes?.[0] || "ä¸Šç€‘ãƒã‚¹");
    if($("#cfg-bus-1")) $("#cfg-bus-1").value = (APP.defaultBusTypes?.[1] || "ç·å…ƒãƒã‚¹");
    if($("#cfg-bus-2")) $("#cfg-bus-2").value = (APP.defaultBusTypes?.[2] || "å¸‚éƒ¨ãƒ»ç”°ä»£ãƒã‚¹");
    showToast("ãƒã‚¹åã‚’åˆæœŸå€¤ã«æˆ»ã—ã¾ã—ãŸï¼ˆä¿å­˜ã§ç¢ºå®šï¼‰");
  };

  $("#btn-logout").onclick=async()=>{
    try{
      await window.firebase.auth().signOut();
      showToast("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
    }catch(e){
      console.warn(e);
      showToast("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•—");
    }
  };

  $("#btn-cloud-error-close").onclick=()=>hideCloudError();

  $("#btn-export-json").onclick=exportJSON;
  $("#btn-export-csv").onclick=exportCSV;

  $("#file-import-csv").addEventListener("change", async(e)=>{
    const f=e.target.files?.[0];
    if(!f) return;
    await importCSV(f);
    e.target.value="";
  });

  $("#btn-factory-reset").onclick=()=>{
    if(!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆåç°¿ãƒ»æ—¥ã€…ã®çŠ¶æ…‹ãƒ»è¡¨ç¤ºåï¼‰ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) return;
    localStorage.removeItem(APP.storageKey);
    location.reload();
  };

  $("#student-form").addEventListener("submit", async(e)=>{
    e.preventDefault();
    if(!State.backend){ showToast("æœªãƒ­ã‚°ã‚¤ãƒ³ / æœªæ¥ç¶šã§ã™"); return; }

    const editId=$("#edit-id").value;
    const item={
      id: editId ? Number(editId) : (Date.now()+Math.floor(Math.random()*10000)),
      class: $("#input-class").value.trim(),
      num: Number($("#input-num").value) || 0,
      name: $("#input-name").value.trim(),
      bus: $("#input-bus").value.trim(),
      stop: $("#input-stop").value.trim()
    };
    if(!item.class || !item.num || !item.name){ showToast("å…¥åŠ›ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); return; }

    let roster=State.roster.slice();
    if(editId){
      const idx=roster.findIndex(s=>String(s.id)===String(editId));
      if(idx>=0) roster[idx]=item;
    }else{
      roster.push(item);
    }

    await State.backend.saveRoster(roster);
    Settings.cancelEdit();
    showToast(editId ? "ä¿å­˜ã—ã¾ã—ãŸ" : "è¿½åŠ ã—ã¾ã—ãŸ");
    renderAll();
    $("#input-num").focus();
  });

  $("#btn-cancel-edit").onclick=()=>Settings.cancelEdit();

  window.addEventListener("resize", ()=>{
    if(State.tab==="monitor"){
      layoutMonitor();
      fitMonitor();
    }
  });

  // login button
  $("#btn-login").onclick = async ()=>{
    const email = ($("#login-email").value || "").trim();
    const pass  = ($("#login-password").value || "").trim();

    $("#login-error").classList.add("hidden");
    $("#login-error").textContent="";

    try{
      if(!hasValidFirebaseConfig(PRESET_FIREBASE_CONFIG)){
        throw new Error("PRESET_FIREBASE_CONFIG ãŒæœªè¨­å®šã§ã™ï¼ˆã‚³ãƒ¼ãƒ‰å†…ã®YOUR_...ã‚’å·®ã—æ›¿ãˆï¼‰");
      }
      await window.firebase.auth().setPersistence(window.firebase.auth.Auth.Persistence.LOCAL);
      await window.firebase.auth().signInWithEmailAndPassword(email, pass);
      showToast("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ");
    }catch(e){
      console.warn(e);
      $("#login-error").textContent = String(e?.message || e);
      $("#login-error").classList.remove("hidden");
    }
  };

  // åˆæœŸå€¤ï¼ˆå…±é€šIDï¼‰
  $("#login-email").value = "bus@otakisho.local";
  $("#login-password").value = "otakisho";
}

/* 5ç§’ã”ã¨UIãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆ */
function startHeartbeat(){
  setInterval(()=>{
    if(State.tab==="monitor"){
      layoutMonitor();
      fitMonitor();
    }
  }, 5000);
}

async function initFirebaseOrDie(){
  if(!window.firebase) throw new Error("Firebase SDKãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“");
  if(!hasValidFirebaseConfig(PRESET_FIREBASE_CONFIG)){
    throw new Error("PRESET_FIREBASE_CONFIG ãŒæœªè¨­å®šã§ã™ï¼ˆYOUR_...ã‚’å·®ã—æ›¿ãˆï¼‰");
  }
  // initializeApp ã¯ backend å´ã§ã‚‚è¡Œã†ãŒã€Auth listener ã®ãŸã‚å…ˆã«å®‰å…¨ã«åˆæœŸåŒ–
  if(!window.firebase.apps?.length){
    window.firebase.initializeApp(PRESET_FIREBASE_CONFIG);
  }
}

/* èµ·å‹• */
window.addEventListener("DOMContentLoaded", async ()=>{
  bind();
  try{
    await initFirebaseOrDie();
  }catch(e){
    console.warn(e);
    showCloudError(String(e?.message || e));
    showLogin(false);
    return;
  }

  // Auth state listener
  window.firebase.auth().onAuthStateChanged(async (user)=>{
    setAuthPill();
    if(user){
      showLogin(false);
      hideCloudError();
      await applyBackend();
      UI.switchTab("check");
    }else{
      // æœªãƒ­ã‚°ã‚¤ãƒ³ï¼šè³¼èª­è§£é™¤ + ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
      if(unsubRoster){ unsubRoster(); unsubRoster=null; }
      if(unsubDaily){ unsubDaily(); unsubDaily=null; }
      State.backend=null;
      State.cloudReady=false;
      setCloudPill();
      showLogin(true);
    }
    renderAll();
  });

  startHeartbeat();
});
</script>
</body>
</html>
